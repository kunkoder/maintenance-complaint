<div th:fragment="part-modal">
    <!-- Modal: Add Part -->
    <div class="modal fade" id="addPartModal" tabindex="-1" role="dialog" aria-labelledby="addPartModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white no-bd">
                    <h5 class="modal-title" id="addPartModalLabel">
                        <i class="fas fa-plus-circle mr-2"></i> Add Part
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <!-- Search Input -->
                    <div class="form-group mb-3">
                        <label for="partSearch">Search Parts</label>
                        <input type="text" class="form-control" id="partSearch" placeholder="Search by code or name...">
                    </div>

                    <!-- Parts List -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="availablePartsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th>Part Code</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-code="MTR-2001" data-name="AC Motor 1.5kW" data-category="Mechanical">
                                    <td><code class="bg-light px-2 py-1 rounded">MTR-2001</code></td>
                                    <td>AC Motor 1.5kW</td>
                                    <td>Mechanical</td>
                                    <td class="text-center">
                                        <button class="btn btn-primary btn-sm select-part-btn">
                                            <i class="fas fa-plus"></i> Select
                                        </button>
                                    </td>
                                </tr>
                                <tr data-code="BRG-8890" data-name="Ball Bearing 6205" data-category="Mechanical">
                                    <td><code class="bg-light px-2 py-1 rounded">BRG-8890</code></td>
                                    <td>Ball Bearing 6205</td>
                                    <td>Mechanical</td>
                                    <td class="text-center">
                                        <button class="btn btn-primary btn-sm select-part-btn">
                                            <i class="fas fa-plus"></i> Select
                                        </button>
                                    </td>
                                </tr>
                                <tr data-code="SEAL-102" data-name="O-Ring Seal Kit" data-category="Seals">
                                    <td><code class="bg-light px-2 py-1 rounded">SEAL-102</code></td>
                                    <td>O-Ring Seal Kit</td>
                                    <td>Seals</td>
                                    <td class="text-center">
                                        <button class="btn btn-primary btn-sm select-part-btn">
                                            <i class="fas fa-plus"></i> Select
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-2 pb-4 px-4">
                    <button type="button" class="btn btn-danger btn-border" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Confirm Delete Part -->
    <div class="modal fade" id="deletePartModal" tabindex="-1" role="dialog" aria-labelledby="deletePartModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white no-bd">
                    <h5 class="modal-title" id="deletePartModalLabel">
                        <i class="fas fa-trash-alt mr-2"></i> Remove Part
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <p>Are you sure you want to remove this part from the list?</p>
                    <strong id="partToRemove" class="text-dark"></strong>
                    <p class="text-muted mt-2 mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0 pt-2 pb-4 px-4">
                    <button type="button" class="btn btn-secondary btn-border" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger ml-2" id="confirmRemovePart">Yes, Remove</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            let partsInUse = []; // Store parts added to the table

            // === SEARCH FUNCTIONALITY ===
            $('#partSearch').on('keyup', function () {
                const value = $(this).val().toLowerCase();
                $('#availablePartsTable tbody tr').filter(function () {
                    $(this).toggle(
                        $(this).text().toLowerCase().indexOf(value) > -1
                    );
                });
            });

            // === SELECT PART FROM MODAL ===
            $('.select-part-btn').on('click', function () {
                const row = $(this).closest('tr');
                const code = row.data('code');
                const name = row.data('name');
                const category = row.data('category');

                // Check if already added
                if (partsInUse.includes(code)) {
                    alert('This part is already added.');
                    return;
                }

                // Prompt for quantity
                const qty = prompt(`Enter quantity for ${name}:`, '1');
                if (!qty || isNaN(qty) || qty <= 0) {
                    alert('Please enter a valid quantity.');
                    return;
                }

                // Add to table
                const newRow = `
            <tr data-code="${code}">
                <td class="pl-3"><code class="bg-light px-2 py-1 rounded">${code}</code></td>
                <td>${name}</td>
                <td>${category}</td>
                <td class="text-center font-weight-bold" contenteditable="true" data-original="${qty}">${qty}</td>
                <td class="text-center">
                    <button class="btn btn-link text-danger btn-sm delete-row"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>`;
                $('#partsTable tbody').append(newRow);
                partsInUse.push(code);

                // Update hidden input
                updatePartsUsedField();

                // Notify user
                toastr.success(`${name} added to list.`);
            });

            // === DELETE PART CONFIRMATION ===
            $('#partsTable').on('click', '.delete-row', function () {
                const row = $(this).closest('tr');
                const partName = row.find('td:eq(1)').text();
                const partCode = row.data('code');

                $('#partToRemove').text(`${partName} (${partCode})`);
                $('#deletePartModal').data('row', row); // Store reference
                $('#deletePartModal').modal('show');
            });

            // Confirm deletion
            $('#confirmRemovePart').on('click', function () {
                const modal = $('#deletePartModal');
                const row = modal.data('row');
                const code = row.data('code');

                row.remove();
                partsInUse = partsInUse.filter(c => c !== code);
                updatePartsUsedField();

                modal.modal('hide');
                toastr.info('Part removed.');
            });

            // === UPDATE HIDDEN FIELD (for form submission) ===
            function updatePartsUsedField() {
                const partsData = [];
                $('#partsTable tbody tr').each(function () {
                    const code = $(this).data('code');
                    const name = $(this).find('td:eq(1)').text();
                    const category = $(this).find('td:eq(2)').text();
                    const qty = $(this).find('td:eq(3)').text().trim();
                    partsData.push({ code, name, category, qty });
                });
                $('#partsUsedData').val(JSON.stringify(partsData));
            }

            // === MAKE QUANTITY EDITABLE & SYNC ===
            $('#partsTable').on('blur', 'td[contenteditable]', function () {
                const oldVal = $(this).data('original');
                const newVal = $(this).text().trim();
                if (isNaN(newVal) || newVal <= 0) {
                    $(this).text(oldVal);
                } else {
                    $(this).data('original', newVal);
                    updatePartsUsedField();
                }
            });

            // === OPEN ADD PART MODAL ===
            $('#addPartBtn').on('click', function () {
                $('#partSearch').val('');
                $('#availablePartsTable tbody tr').show(); // Reset filter
                $('#addPartModal').modal('show');
            });
        });
    </script>
</div>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layouts/dashboard}">

<head>
    <title>Documents</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="page-inner">
            <div class="page-header">
                <h4 class="page-title" th:text="${title}"></h4>
                <ul class="breadcrumbs">
                    <li class="nav-home">
                        <a>
                            <i class="fas fa-exclamation-triangle"></i>
                        </a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a>Menu</a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a th:text="${title}"></a>
                    </li>
                </ul>
            </div>
            <div class="row">
                <div class="col-md-12 ml-auto mr-auto">
                    <div class="card card-profile">
                        <form id="complaintForm" th:action="@{/complaints/update}" method="post"
                            enctype="multipart/form-data">
                            <div class="card-body">
                                <!-- Header: ID & Status -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0 text-muted" th:id="${'complaint-key'}" th:text="${complaint?.code}">
                                    </h5>
                                    <span class="badge" th:id="${'status-field'}"
                                        th:classappend="${(complaint.status == 'OPEN') ? 'badge-danger' : (complaint.status == 'IN_PROGRESS') ? 'badge-warning' : (complaint.status == 'PENDING') ? 'badge-info' : (complaint.status == 'DONE') ? 'badge-primary' : 'badge-success'}"
                                        th:text="${complaint.status}" style="cursor: pointer; font-weight: 600;"
                                        title="Click to change status"></span>
                                    <input type="hidden" name="id" th:value="${complaint.id}" />
                                    <input type="hidden" name="status" th:value="${complaint.status}"
                                        id="status-input" />
                                    <!-- <span class="badge badge-success text-uppercase" id="status-field"
                                        style="cursor: pointer; font-weight: 600;" title="Click to change status">
                                        CLOSED
                                    </span>
                                    <input type="hidden" name="status" value="CLOSED"> -->
                                </div>

                                <!-- Subject (Editable) -->
                                <h3 class="mb-3 pb-2" contenteditable="true" th:id="${'subject-field'}"
                                    th:data-original="${complaint.subject}" th:text="${complaint.subject}"
                                    style="cursor: text; border-bottom: 2px dashed #ccc; transition: border-color 0.2s;"
                                    onfocus="this.style.borderBottom = '2px dashed #007bff';"
                                    onblur="this.style.borderBottom = '2px dashed #ccc'; updateHiddenInput(this, 'subject-input');">
                                </h3>
                                <input type="hidden" name="subject" th:value="${complaint.subject}"
                                    id="subject-input" />

                                <!-- Badges: Priority, Category -->
                                <div class="mb-4">
                                    <span class="badge badge-info">MAINTENANCE</span>

                                    <span class="badge"
                                        th:classappend="${(complaint.priority == 'HIGH') ? 'badge-danger' : (complaint.priority == 'MEDIUM') ? 'badge-warning' : 'badge-secondary'}"
                                        th:text="${complaint.priority} + ' PRIORITY'" id="priority-field"
                                        style="cursor: pointer;" title="Click to edit"></span>
                                    <input type="hidden" name="priority" th:value="${complaint.priority}"
                                        id="priority-input" />

                                    <span class="badge badge-dark" th:text="${complaint.category}" id="category-field"
                                        style="cursor: pointer;" title="Click to edit"></span>
                                    <input type="hidden" name="category" th:value="${complaint.category}"
                                        id="category-input" />
                                </div>

                                <!-- Details Grid -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong>Reporter:</strong>
                                            <span th:id="${'reporter-field'}" class="ml-2"
                                                th:data-original="${complaint.reporter.name + ' (' + complaint.reporter.employeeId + ')'}"
                                                th:text="${complaint.reporter.name + ' (' + complaint.reporter.employeeId + ')'}">
                                            </span>
                                        </p>
                                        <input type="hidden" name="reporterName"
                                            th:value="${complaint.reporter.name}" />
                                        <input type="hidden" name="reporter.employeeId"
                                            th:value="${complaint.reporter.employeeId}" />

                                        <!-- Assignee -->
                                        <p class="mb-2">
                                            <strong>Assignee:</strong>
                                            <input type="text"
                                                class="form-control form-control-sm d-inline-block w-auto"
                                                list="userOptions" id="assigneeInput"
                                                style="border: none; cursor: text; border-bottom: 1px dashed #ccc;"
                                                onfocus="this.style.borderBottom = '1px dashed #007bff';"
                                                onblur="this.style.borderBottom = '1px dashed #ccc';" />
                                        </p>
                                        <!-- <input type="hidden" name="assigneeName" id="assigneeName" />
                                        <input type="hidden" name="assigneeEmployeeId" id="assigneeEmployeeId" /> -->
                                        <input type="hidden" name="assigneeName" id="assigneeName" />
                                        <input type="hidden" name="assignee.employeeId" id="assigneeEmployeeId" />

                                        <datalist id="userOptions">
                                            <option th:each="user : ${users}"
                                                th:value="${user.name} + ' (' + ${user.employeeId} + ')'"
                                                th:data-employee-id="${user.employeeId}">
                                            </option>
                                        </datalist>
                                        <!-- Area -->
                                        <p class="mb-2">
                                            <strong>Area:</strong>
                                            <input type="text"
                                                class="form-control form-control-sm d-inline-block w-auto"
                                                list="areaOptions" id="areaInput" placeholder="Search area..."
                                                style="border: none; cursor: text; border-bottom: 1px dashed #ccc;"
                                                onfocus="this.style.borderBottom = '1px dashed #007bff';"
                                                onblur="this.style.borderBottom = '1px dashed #ccc';" />
                                        </p>
                                        <input type="hidden" name="areaName" id="areaName" />
                                        <input type="hidden" name="area.code" id="areaCode" />

                                        <datalist id="areaOptions">
                                            <option th:each="area : ${areas}"
                                                th:value="${area.name} + ' (' + ${area.code} + ')'"
                                                th:data-code="${area.code}">
                                            </option>
                                        </datalist>

                                        <!-- Equipment -->
                                        <p class="mb-2">
                                            <strong>Equipment:</strong>
                                            <input type="text"
                                                class="form-control form-control-sm d-inline-block w-auto"
                                                list="equipmentOptions" id="equipmentInput"
                                                placeholder="Search equipment..."
                                                style="border: none; cursor: text; border-bottom: 1px dashed #ccc;"
                                                onfocus="this.style.borderBottom = '1px dashed #007bff';"
                                                onblur="this.style.borderBottom = '1px dashed #ccc';" />
                                        </p>
                                        <input type="hidden" name="equipmentName" id="equipmentName" />
                                        <input type="hidden" name="equipment.code" id="equipmentCode" />

                                        <datalist id="equipmentOptions">
                                            <option th:each="equipment : ${equipments}"
                                                th:value="${equipment.name} + ' (' + ${equipment.code} + ')'"
                                                th:data-code="${equipment.code}">
                                            </option>
                                        </datalist>

                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong>Report Date:</strong>
                                            <span id="report-date-field" class="ml-2 editable-field"
                                                style="cursor: pointer; border-bottom: 1px dashed #ccc;"
                                                title="Click to edit"
                                                th:data-original="${#temporals.format(complaint.reportDate, 'yyyy-MM-dd HH:mm')}"
                                                th:text="${#temporals.format(complaint.reportDate, 'MMM d, yyyy HH:mm')}">
                                            </span>
                                        </p>
                                        <input type="hidden" name="reportDate" id="reportDateInput"
                                            th:value="${#temporals.format(complaint.reportDate, 'yyyy-MM-dd''T''HH:mm')}" />

                                        <p class="mb-2" th:if="${complaint.closeTime != null}">
                                            <strong>Close Time:</strong>
                                            <span th:id="${'close-time-field'}"
                                                th:data-original="${#temporals.format(complaint.closeTime, 'MMM d, yyyy HH:mm')}"
                                                th:text="${#temporals.format(complaint.closeTime, 'MMM d, yyyy HH:mm')}">
                                            </span>
                                        </p>
                                        <input type="hidden" name="closeTime"
                                            th:value="${#temporals.format(complaint.closeTime, 'yyyy-MM-dd HH:mm')}"
                                            th:if="${complaint.closeTime != null}" />

                                        <p class="mb-2">
                                            <strong>Resolution Time:</strong>
                                            <span th:id="${'resolution-time-field'}"
                                                th:data-original="${complaint.totalResolutionTimeMinutes != null ? complaint.totalResolutionTimeMinutes + ' minutes' : '-'}"
                                                th:text="${complaint.totalResolutionTimeMinutes != null ? complaint.totalResolutionTimeMinutes + ' minutes' : '-'}">
                                            </span>
                                        </p>
                                        <input type="hidden" name="totalResolutionTimeMinutes"
                                            th:value="${complaint.totalResolutionTimeMinutes}" />
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-4">
                                    <h5 class="d-flex align-items-center mb-2">
                                        <i class="fas fa-align-left mr-2 text-primary"></i> Description
                                    </h5>
                                    <textarea id="description-field" class="form-control" rows="6" readonly
                                        th:data-original="${complaint.description}" th:text="${complaint.description}"
                                        style="background-color: #f9f9fb; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Segoe UI', sans-serif; cursor: pointer;"
                                        onclick="this.readOnly = false; this.style.backgroundColor = '#fff'; this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,.1)'; this.focus();"
                                        onblur="updateHiddenInput(this, 'description-input')">
                            </textarea>
                                    <input type="hidden" name="description" th:value="${complaint.description}"
                                        id="description-input" />
                                </div>

                                <!-- Action Taken -->
                                <div class="mb-4">
                                    <h5 class="d-flex align-items-center mb-2">
                                        <i class="fas fa-wrench mr-2 text-success"></i> Action Taken
                                    </h5>
                                    <textarea id="action-taken-field" class="form-control" rows="6" readonly
                                        th:data-original="${complaint.actionTaken}" th:text="${complaint.actionTaken}"
                                        style="background-color: #f9f9fb; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Segoe UI', sans-serif; cursor: pointer;"
                                        onclick="this.readOnly = false; this.style.backgroundColor = '#fff'; this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,.1)'; this.focus();"
                                        onblur="updateHiddenInput(this, 'action-taken-input')">
                            </textarea>
                                    <input type="hidden" name="actionTaken" th:value="${complaint.actionTaken}"
                                        id="action-taken-input" />
                                </div>

                                <!-- BEFORE & AFTER IMAGES -->
                                <div class="mb-4">
                                    <h5 class="d-flex align-items-center mb-3">
                                        <i class="fas fa-images mr-2 text-primary"></i> Visual Documentation
                                    </h5>
                                    <div class="row">
                                        <!-- BEFORE REPAIR -->
                                        <div class="col-md-6">
                                            <div class="card border-light shadow-sm h-50">
                                                <div
                                                    class="card-header bg-light d-flex justify-content-between align-items-center">
                                                    <strong class="text-warning">
                                                        <i class="fas fa-camera mr-1"></i> Before Repair
                                                    </strong>
                                                </div>
                                                <div class="card-body d-flex flex-column align-items-center text-center p-3"
                                                    style="cursor: pointer; background-color: #fcfcfd;"
                                                    onclick="this.querySelector('input[type=file]').click();">
                                                    <div id="beforeImageContainer"
                                                        class="w-100 d-flex justify-content-center">
                                                        <img id="beforeImagePreview" src="" alt="Before Repair Preview"
                                                            class="img-fluid rounded"
                                                            style="max-height: 300px; object-fit: scale-down; display: none;">
                                                        <div id="beforeImagePlaceholder" class="text-muted">
                                                            <i class="fas fa-image fa-2x mb-2"
                                                                style="opacity: 0.3;"></i>
                                                            <p class="mb-0 small">No image</p>
                                                        </div>
                                                    </div>
                                                    <input type="file" name="imageBeforeFile" accept="image/*"
                                                        style="display: none;"
                                                        onchange="handleImageUpload(this, 'beforeImagePreview', 'beforeImagePlaceholder')" />
                                                </div>
                                            </div>
                                        </div>
                                        <!-- AFTER REPAIR -->
                                        <div class="col-md-6">
                                            <div class="card border-light shadow-sm h-50">
                                                <div
                                                    class="card-header bg-light d-flex justify-content-between align-items-center">
                                                    <strong class="text-success">
                                                        <i class="fas fa-check-circle mr-1"></i> After Repair
                                                    </strong>
                                                </div>
                                                <div class="card-body d-flex flex-column align-items-center text-center p-3"
                                                    style="cursor: pointer; background-color: #fcfcfd;"
                                                    onclick="this.querySelector('input[type=file]').click();">
                                                    <div id="afterImageContainer"
                                                        class="w-100 d-flex justify-content-center">
                                                        <img id="afterImagePreview" src="" alt="After Repair Preview"
                                                            class="img-fluid rounded"
                                                            style="max-height: 300px; object-fit: scale-down; display: none;">
                                                        <div id="afterImagePlaceholder" class="text-muted">
                                                            <i class="fas fa-image fa-2x mb-2"
                                                                style="opacity: 0.3;"></i>
                                                            <p class="mb-0 small">No image</p>
                                                        </div>
                                                    </div>
                                                    <input type="file" name="imageAfterFile" accept="image/*"
                                                        style="display: none;"
                                                        onchange="handleImageUpload(this, 'afterImagePreview', 'afterImagePlaceholder')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Parts Used -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="d-flex align-items-center mb-0">
                                            <i class="fas fa-cogs mr-2 text-secondary"></i> Parts Used
                                        </h5>
                                        <button type="button" class="btn btn-primary btn-sm btn-round"
                                            data-toggle="modal" data-target="#addPartModal">
                                            <i class="fas fa-plus"></i> Add Part
                                        </button>
                                    </div>

                                    <!-- Include Parts Modal -->
                                    <div th:replace="~{complaint/part-modal :: part-modal}"></div>

                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm" id="partsTable">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Part Code</th>
                                                    <th>Name</th>
                                                    <th>Category</th>
                                                    <th class="text-center">Qty</th>
                                                    <th class="text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="partDto : ${complaint.partsUsed}"
                                                    th:attr="data-part-id=${partDto.part.id}, data-part-code=${partDto.part.code}">
                                                    <td><code class="bg-light px-2 py-1 rounded"
                                                            th:text="${partDto.part.code}"></code></td>
                                                    <td th:text="${partDto.part.name}"></td>
                                                    <td th:text="${partDto.part.category}"></td>
                                                    <td class="text-center font-weight-bold" contenteditable="true"
                                                        th:data-original="${partDto.quantity}"
                                                        th:text="${partDto.quantity}"></td>
                                                    <td class="text-center">
                                                        <button class="btn btn-link text-danger btn-sm delete-row"
                                                            type="button">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Dynamic hidden inputs for Spring binding -->
                                    <div id="partsUsedInputs"></div>
                                    <!-- <input type="hidden" name="partsUsedJson" id="partsUsedData" value="" /> -->
                                    <!-- <input type="hidden" name="partsUsed" id="partsUsedData" value="" /> -->
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-4">
                                    <small class="text-muted">
                                        Last updated:
                                        <span th:id="${'updated-at-field'}"
                                            th:data-original="${#temporals.format(complaint.updatedAt, 'MMM d, yyyy HH:mm')}"
                                            th:text="${#temporals.format(complaint.updatedAt, 'MMM d, yyyy HH:mm')}">
                                        </span>
                                    </small>
                                    <div>
                                        <button type="button"
                                            class="btn btn-danger btn-border btn-round mr-2 delete-row"
                                            th:data-id="${complaint.id}" th:data-name="${complaint.subject}"
                                            data-toggle="modal" data-target="#deleteConfirmModal">
                                            <i class="fas fa-trash-alt"></i> Delete
                                        </button>
                                        <button class="btn btn-primary btn-round" id="saveChangesBtn">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            const USERS = /*[[${users}]]*/[];
            const AREAS = /*[[${areas}]]*/[];
            const EQUIPMENTS = /*[[${equipments}]]*/[];
            const COMPLAINT = /*[[${complaint}]]*/ null;
            /*]]>*/
        </script>

        <script>
            // --- Delete Modal Trigger ---
            $('.delete-row').on('click', function () {
                const name = $(this).data('name');
                const id = $(this).data('id');

                $('#deleteDocName').text(name);
                $('#confirmDeleteButton').attr('href', '/complaints/delete/' + encodeURIComponent(id));
                $('#deleteRowModal').modal('show');
            });

            document.addEventListener("DOMContentLoaded", function () {
                function updatePartsUsedInputs() {
                    const container = document.getElementById('partsUsedInputs');
                    container.innerHTML = ''; // Clear existing

                    const rows = document.querySelectorAll('#partsTable tbody tr');
                    rows.forEach((row, index) => {
                        const code = row.querySelector('code').textContent.trim();
                        const name = row.querySelector('td:nth-child(2)').textContent.trim();
                        const category = row.querySelector('td:nth-child(3)').textContent.trim();
                        const qty = row.querySelector('td:nth-child(4)').getAttribute('data-original') || '1';
                        const id = row.getAttribute('data-part-id'); // Assumes you store ID on the row

                        // Helper to create hidden input
                        function addField(name, value) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = name;
                            input.value = value;
                            container.appendChild(input);
                        }

                        // Add all fields
                        addField(`partsUsed[${index}].part.code`, code);
                        addField(`partsUsed[${index}].part.name`, name);
                        addField(`partsUsed[${index}].part.category`, category);
                        addField(`partsUsed[${index}].part.id`, id); // ðŸ‘ˆ ADD THIS LINE
                        addField(`partsUsed[${index}].quantity`, qty);
                    });
                }


                function linkInputToHidden(inputId, ...hiddenIdConfigs) {
                    const input = document.getElementById(inputId);
                    if (!input) return;

                    input.addEventListener('input', function () {
                        const selectedOption = [...document.querySelectorAll(`#${input.list.id} option`)]
                            .find(opt => opt.value === input.value);

                        hiddenIdConfigs.forEach(config => {
                            let value = '';
                            if (typeof config === 'string') {
                                value = input.value.trim();
                            } else if (config.id && config.extract) {
                                value = selectedOption ? selectedOption.dataset[config.extract] : '';
                            }

                            const field = document.getElementById(config.id || config);
                            if (field) field.value = value;
                        });
                    });
                }

                // === 2. Prefill Input from Data ===
                function setTextInput(inputId, value) {
                    const input = document.getElementById(inputId);
                    if (input) input.value = value;
                }

                linkInputToHidden('assigneeInput',
                    { id: 'assigneeName', extract: null },
                    { id: 'assigneeEmployeeId', extract: 'employeeId' }
                );

                linkInputToHidden('areaInput',
                    { id: 'areaName', extract: null },
                    { id: 'areaCode', extract: 'code' }
                );

                linkInputToHidden('equipmentInput',
                    { id: 'equipmentName', extract: null },
                    { id: 'equipmentCode', extract: 'code' }
                );

                if (COMPLAINT) {
                    // Assignee
                    if (COMPLAINT.assignee) {
                        const name = COMPLAINT.assignee.name;
                        const id = COMPLAINT.assignee.employeeId;
                        if (name && id) {
                            // Display: "Alice (EMP001)"
                            document.getElementById('assigneeInput').value = `${name} (${id})`;
                            // Hidden input: only "EMP001"
                            document.getElementById('assigneeName').value = name;
                            document.getElementById('assigneeEmployeeId').value = id; // â† Only ID
                        }
                    }

                    // Area
                    if (COMPLAINT.area) {
                        const name = COMPLAINT.area.name;
                        const code = COMPLAINT.area.code;
                        if (name && code) {
                            document.getElementById('areaInput').value = `${name} (${code})`;
                            document.getElementById('areaName').value = name;
                            document.getElementById('areaCode').value = code;
                        }
                    }

                    // Equipment
                    if (COMPLAINT.equipment) {
                        const name = COMPLAINT.equipment.name;
                        const code = COMPLAINT.equipment.code;
                        if (name && code) {
                            document.getElementById('equipmentInput').value = `${name} (${code})`;
                            document.getElementById('equipmentName').value = name;
                            document.getElementById('equipmentCode').value = code;
                        }
                    }
                }

                // === 5. Editable Badge: Click â†’ Select Dropdown ===
                function makeEditable(fieldId, options, dynamicOptionsFn = null) {
                    const field = document.getElementById(fieldId);
                    if (!field) return;

                    const originalValue = field.getAttribute('data-original') || field.innerText.trim();
                    field.setAttribute('data-original', originalValue);
                    field.style.cursor = 'pointer';
                    field.title = 'Click to edit';

                    field.addEventListener('click', function () {
                        if (field.querySelector('select')) return; // Already editing

                        let availableOptions = [];
                        if (dynamicOptionsFn) {
                            availableOptions = dynamicOptionsFn(originalValue);
                        } else if (Array.isArray(options)) {
                            availableOptions = options;
                        }

                        if (availableOptions.length === 0) return;

                        const select = document.createElement('select');
                        select.className = 'form-control form-control-sm';
                        select.style.cssText = `
                        padding: 0.3em 0.6em;
                        font-size: ${window.getComputedStyle(field).fontSize};
                        border-radius: 0.25rem;
                        border: 2px solid ${window.getComputedStyle(field).color};
                        background: ${window.getComputedStyle(field).backgroundColor};
                        color: ${window.getComputedStyle(field).color};
                    `;

                        availableOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === originalValue) option.selected = true;
                            select.appendChild(option);
                        });

                        field.innerHTML = '';
                        field.appendChild(select);
                        select.focus();

                        select.addEventListener('blur', function () {
                            const newValue = select.value;
                            if (newValue && newValue !== originalValue) {
                                field.innerText = newValue;
                                field.setAttribute('data-original', newValue);

                                // Update badge class if needed
                                if (field.classList.contains('badge')) {
                                    updateBadgeClass(field, newValue);
                                }
                            } else {
                                field.innerText = originalValue;
                            }
                        });

                        select.addEventListener('change', function () {
                            select.blur();
                        });
                    });
                }

                // === 10. Make Date Field Editable ===
                function makeDateEditable(fieldId, inputId, format = 'datetime-local') {
                    const field = document.getElementById(fieldId);
                    const hiddenInput = document.getElementById(inputId);
                    if (!field || !hiddenInput) return;

                    const originalDisplay = field.innerText.trim();
                    const originalValue = field.getAttribute('data-original') || hiddenInput.value;

                    field.style.cursor = 'pointer';
                    field.title = 'Click to edit';

                    field.addEventListener('click', function () {
                        if (field.querySelector('input')) return; // Already editing

                        const input = document.createElement('input');
                        input.type = format;
                        input.className = 'form-control form-control-sm';
                        input.style.cssText = `
            width: auto;
            display: inline-block;
            padding: 0.3em 0.6em;
            font-size: ${window.getComputedStyle(field).fontSize};
            border: 1px solid #007bff;
            border-radius: 4px;
            background: white;
        `;

                        // Convert "MMM d, yyyy HH:mm" â†’ "yyyy-MM-ddTHH:mm"
                        if (originalValue) {
                            const date = new Date(originalValue);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            input.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        }

                        field.innerHTML = '';
                        field.appendChild(input);
                        input.focus();

                        input.addEventListener('blur', function () {
                            const newValue = input.value;
                            if (!newValue) {
                                field.innerText = originalDisplay;
                                return;
                            }

                            // Update hidden input
                            hiddenInput.value = newValue;

                            // Update display: format as "MMM d, yyyy HH:mm"
                            const date = new Date(newValue);
                            const formatted = date.toLocaleDateString('en-US', {
                                month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                            });
                            field.innerText = formatted;
                            field.setAttribute('data-original', newValue);
                        });

                        // Allow Enter to save
                        input.addEventListener('keydown', function (e) {
                            if (e.key === 'Enter') input.blur();
                        });
                    });
                }

                // Initialize
                makeDateEditable('report-date-field', 'reportDateInput', 'datetime-local');

                // === 6. Update Badge Class ===
                function updateBadgeClass(badge, value) {
                    badge.classList.remove(
                        'badge-danger', 'badge-warning', 'badge-info', 'badge-primary', 'badge-success', 'badge-secondary'
                    );

                    if (value === 'OPEN') badge.classList.add('badge-danger');
                    else if (value === 'IN_PROGRESS') badge.classList.add('badge-warning');
                    else if (value === 'PENDING') badge.classList.add('badge-info');
                    else if (value === 'DONE') badge.classList.add('badge-primary');
                    else if (value === 'CLOSED') badge.classList.add('badge-success');
                    else badge.classList.add('badge-secondary');
                }

                // === 7. Dynamic Options for Status ===
                function getStatusOptions(currentStatus) {
                    switch (currentStatus) {
                        case 'OPEN': return ['OPEN', 'IN_PROGRESS'];
                        case 'IN_PROGRESS': return ['IN_PROGRESS', 'PENDING', 'CLOSED'];
                        case 'PENDING': return ['PENDING', 'IN_PROGRESS', 'CLOSED'];
                        case 'CLOSED': return ['CLOSED', 'IN_PROGRESS'];
                        default: return [];
                    }
                }

                // === 8. Initialize Editable Badges ===
                makeEditable('status-field', null, getStatusOptions);
                makeEditable('priority-field', ['HIGH PRIORITY', 'MEDIUM PRIORITY', 'LOW PRIORITY']);
                makeEditable('category-field', ['MECHANICAL', 'ELECTRICAL', 'IT']);



                // === 9. Image Upload Preview ===
                window.handleImageUpload = function (input, previewId, placeholderId) {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById(previewId);
                        const placeholder = document.getElementById(placeholderId);
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        if (placeholder) placeholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                };


                const complaintForm = document.getElementById('complaintForm');

                // Define updateHiddenInput
                function updateHiddenInput(element, hiddenInputId) {
                    const hiddenInput = document.getElementById(hiddenInputId);
                    if (hiddenInput) {
                        hiddenInput.value = element.textContent || element.value;
                    }
                }

                console.log(complaintForm);
                complaintForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    if (typeof updatePartsUsedInputs === 'function') {
                        updatePartsUsedInputs();
                    }

                    // === Sync subject ===
                    const subjectField = document.getElementById('subject-field');
                    if (subjectField) {
                        document.querySelector('input[name="subject"]').value = subjectField.innerText.trim();
                    }

                    // === Sync status, priority, category ===
                    const statusField = document.getElementById('status-field');
                    const priorityField = document.getElementById('priority-field');
                    const categoryField = document.getElementById('category-field');

                    const priorityMap = {
                        'HIGH PRIORITY': 'HIGH',
                        'MEDIUM PRIORITY': 'MEDIUM',
                        'LOW PRIORITY': 'LOW'
                    };

                    // But map to actual value on submit:
                    document.getElementById('priority-input').value = {
                        'HIGH Priority': 'HIGH',
                        'MEDIUM Priority': 'MEDIUM',
                        'LOW Priority': 'LOW'
                    }[priorityField.innerText.trim()] || 'MEDIUM';

                    if (statusField) {
                        const statusValue = statusField.getAttribute('data-original') || statusField.innerText.trim();
                        document.getElementById('status-input').value = statusValue;
                    }

                    if (priorityField) {
                        const priorityDisplay = (priorityField.getAttribute('data-original') || priorityField.innerText.trim()).toUpperCase();
                        document.getElementById('priority-input').value = priorityMap[priorityDisplay] || 'MEDIUM';
                    }

                    if (categoryField) {
                        const categoryValue = categoryField.getAttribute('data-original') || categoryField.innerText.trim();
                        document.getElementById('category-input').value = categoryValue;
                    }

                    // === Sync description and action taken ===
                    const description = document.getElementById('description-field');
                    const actionTaken = document.getElementById('action-taken-field');

                    if (description) {
                        document.getElementById('description-input').value = description.value;
                    }
                    if (actionTaken) {
                        document.getElementById('action-taken-input').value = actionTaken.value;
                    }

                    // === Sync parts used ===
                    if (typeof updatePartsUsedInputs === 'function') {
                        updatePartsUsedInputs();
                    }

                    // âœ… Now submit
                    complaintForm.submit();
                    // Or use fetch() for debugging
                });
            });
        </script>
    </th:block>

</body>

</html>

<!-- NOTE current response:
http://localhost:8000/complaints/74JqB6BGtproxHS7dnF3e1?id=74JqB6BGtproxHS7dnF3e1
&status=OPEN
&subject=SSS
&priority=HIGH
&category=ELECTRICAL
&reporterName=QQQ
&reporterEmployeeId=QQQ
&assigneeName=QQQ
&assigneeEmployeeId=QQQ&
areaName=ZZZ
&areaCode=ZZZ
&equipmentName=QQQ
&equipmentCode=QQQ
&reportDate=2025-08-10+18%3A25
&totalResolutionTimeMinutes=
&description=
&actionTaken=
&imageBeforeFile=
&imageAfterFile=
&partsUsedData= -->



<!-- Scripts Fragment -->
<!-- <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            const USERS = /*[[${users}]]*/[];
            const AREAS = /*[[${areas}]]*/[];
            const EQUIPMENTS = /*[[${equipments}]]*/[];
            /*]]>*/
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // === 1. Sync Function: Input â†’ Hidden Fields ===
                function setupAutocomplete(inputId, datalistId, dataKey, ...hiddenFieldIds) {
                    const input = document.getElementById(inputId);
                    const options = document.querySelectorAll(`#${datalistId} option`);

                    input.addEventListener('input', () => {
                        const selected = [...options].find(opt => opt.value === input.value);
                        const value = selected ? selected.dataset[dataKey] : '';

                        hiddenFieldIds.forEach(id => {
                            const field = document.getElementById(id);
                            if (field) field.value = value;
                        });
                    });
                }

                // === 2. Initialize Autocomplete Sync ===
                setupAutocomplete('assigneeInput', 'userOptions', 'employeeId', 'assigneeEmployeeId', 'assigneeName');
                setupAutocomplete('areaInput', 'areaOptions', 'code', 'areaCode', 'areaName');
                setupAutocomplete('equipmentInput', 'equipmentOptions', 'code', 'equipmentCode', 'equipmentName');

                // === 3. Prefill from Thymeleaf Data ===
                const complaint = /*[[${complaint}]]*/ null;

                if (complaint) {
                    // --- Assignee ---
                    if (complaint.assignee) {
                        const name = complaint.assignee.name;
                        const id = complaint.assignee.employeeId;
                        if (name && id) {
                            document.getElementById('assigneeInput').value = `${name} (${id})`;
                            document.getElementById('assigneeEmployeeId').value = id;
                            document.getElementById('assigneeName').value = name;
                        }
                    }

                    // --- Area ---
                    if (complaint.area) {
                        const name = complaint.area.name;
                        const code = complaint.area.code;
                        if (name && code) {
                            document.getElementById('areaInput').value = `${name} (${code})`;
                            document.getElementById('areaCode').value = code;
                            document.getElementById('areaName').value = name;
                        }
                    }

                    // --- Equipment ---
                    if (complaint.equipment) {
                        const name = complaint.equipment.name;
                        const code = complaint.equipment.code;
                        if (name && code) {
                            document.getElementById('equipmentInput').value = `${name} (${code})`;
                            document.getElementById('equipmentCode').value = code;
                            document.getElementById('equipmentName').value = name;
                        }
                    }
                }

                // === 4. (Keep your other logic: textarea edit, form submit, etc.) ===
            });

            function handleImageUpload(input, previewId, placeholderId) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById(previewId);
                    const placeholder = document.getElementById(placeholderId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            document.addEventListener("DOMContentLoaded", function () {

                function makeTextareaEditable(fieldId) {
                    const textarea = document.getElementById(fieldId);
                    if (!textarea) return;

                    // Style when readonly (static appearance)
                    const readonlyStyle = {
                        backgroundColor: '#f8f9fa',
                        border: '1px solid #ddd',
                        opacity: '0.8',
                        cursor: 'pointer'
                    };

                    // Style when editing
                    const editingStyle = {
                        backgroundColor: '#fff',
                        border: '1px solid #007bff',
                        opacity: '1',
                        boxShadow: '0 0 0 0.2rem rgba(0,123,255,.1)'
                    };

                    // Apply readonly visual style
                    Object.assign(textarea.style, readonlyStyle);

                    textarea.addEventListener('click', function () {
                        if (textarea.readOnly) {
                            // Enable editing
                            textarea.readOnly = false;
                            Object.assign(textarea.style, editingStyle);
                            textarea.focus();
                        }
                    });

                    // Save on blur
                    textarea.addEventListener('blur', function () {
                        const original = textarea.getAttribute('data-original');
                        const current = textarea.value.trim();

                        if (current !== original) {
                            console.log(`Updated: ${fieldId} â†’ "${original}" â†’ "${current}"`);
                            // Here you can send update via AJAX
                            // Example: fetch('/api/update-complaint', { method: 'POST', body: JSON.stringify({ field: fieldId, value: current }) })
                            textarea.setAttribute('data-original', current);
                        }

                        // Reapply readonly state and style
                        textarea.readOnly = true;
                        Object.assign(textarea.style, readonlyStyle);
                    });

                    // Allow Enter to save, Escape to cancel
                    textarea.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            // Ctrl+Enter to save
                            textarea.blur();
                        } else if (e.key === 'Escape') {
                            // Revert to original value
                            textarea.value = textarea.getAttribute('data-original');
                            textarea.blur();
                        }
                    });
                }

                // Initialize editable textareas
                makeTextareaEditable('description-field');
                makeTextareaEditable('action-taken-field');

                // Function to turn field into input on click
                function makeEditable(fieldId, type = 'text', options = null, dynamicOptionsFn = null) {
                    const field = document.getElementById(fieldId);
                    if (!field) return;

                    const originalValue = field.getAttribute('data-original') || field.innerText.trim();
                    field.setAttribute('data-original', originalValue);
                    let input;

                    field.style.cursor = 'pointer';
                    field.title = 'Click to edit';

                    field.addEventListener('click', function (e) {
                        if (field.querySelector('input, select')) return; // Already editing

                        let availableOptions = [];
                        if (dynamicOptionsFn && typeof dynamicOptionsFn === 'function') {
                            availableOptions = dynamicOptionsFn(field.innerText.trim());
                        } else {
                            availableOptions = Array.isArray(options) ? options : [];
                        }

                        if (availableOptions.length === 0) return;

                        input = document.createElement('select');
                        input.className = 'form-control form-control-sm';

                        availableOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === field.innerText.trim()) option.selected = true;
                            input.appendChild(option);
                        });

                        // ðŸ”´ Apply badge-like styling to the select
                        const computedStyle = window.getComputedStyle(field);
                        input.style.backgroundColor = computedStyle.backgroundColor;
                        input.style.color = computedStyle.color;
                        input.style.borderColor = computedStyle.color;
                        input.style.borderWidth = '2px';
                        input.style.borderStyle = 'solid';
                        input.style.borderRadius = '0.25rem';
                        input.style.padding = '0.3em 0.6em';
                        input.style.fontSize = computedStyle.fontSize;
                        input.style.fontWeight = computedStyle.fontWeight;
                        input.style.height = 'auto';
                        input.style.minHeight = 'unset';

                        // Replace field content
                        field.innerHTML = '';
                        field.appendChild(input);
                        input.focus();
                    });

                    // Save on blur
                    field.addEventListener('blur', function (e) {
                        const target = e.relatedTarget || document.activeElement;
                        if (field.contains(target)) return; // Still in the field

                        const select = field.querySelector('select');
                        if (!select) return;

                        const newValue = select.options[select.selectedIndex].text;
                        const oldValue = field.getAttribute('data-original');

                        if (newValue && newValue !== oldValue) {
                            console.log(`Updated: ${fieldId} â†’ "${oldValue}" â†’ "${newValue}"`);
                            field.innerHTML = newValue;
                            field.setAttribute('data-original', newValue);

                            // Update badge class if applicable
                            if (field.classList.contains('badge')) {
                                field.className = getStatusBadgeClass(newValue); // Reapply correct badge class
                            }
                        } else {
                            field.innerHTML = oldValue;
                        }
                    }, true);

                    // Handle Enter and Escape
                    field.addEventListener('keydown', function (e) {
                        const select = field.querySelector('select');
                        if (!select) return;

                        if (e.key === 'Enter') {
                            e.preventDefault();
                            field.blur();
                        } else if (e.key === 'Escape') {
                            field.innerHTML = originalValue;
                        }
                    });
                }


                // Helper to get correct Bootstrap badge class
                function getStatusBadgeClass(status) {
                    switch (status) {
                        case 'OPEN': return 'badge badge-danger';
                        case 'INPROGRESS': return 'badge badge-primary';
                        case 'PENDING': return 'badge badge-warning';
                        case 'CLOSED': return 'badge badge-success';
                        default: return 'badge badge-secondary';
                    }
                }

                // Dynamic options generator for status-field
                function getStatusOptions(currentStatus) {
                    switch (currentStatus) {
                        case 'OPEN':
                            return ['OPEN', 'INPROGRESS'];
                        case 'INPROGRESS':
                            return ['INPROGRESS', 'PENDING', 'CLOSED'];
                        case 'PENDING':
                            return ['PENDING', 'INPROGRESS', 'CLOSED'];
                        case 'CLOSED':
                            return ['CLOSED', 'INPROGRESS'];
                        default:
                            return [];
                    }
                }

                // Initialize editable fields
                makeEditable('subject-field', 'text');
                makeEditable('status-field', 'select', null, getStatusOptions); // Dynamic options
                makeEditable('priority-field', 'select', ['Low Priority', 'Medium Priority', 'High Priority']);
                makeEditable('category-field', 'select', ['Mechanical', 'Electrical', 'Software', 'Safety']);

                // makeEditable('assignee-field', 'select',
                //     USERS.map(u => `${u.name} (${u.employeeId})`)
                // );

                // Area: "Production Floor A (PF-A)"
                makeEditable('area-field', 'select',
                    AREAS.map(a => `${a.name} (${a.code})`)
                );

                // Equipment: "Conveyor-5 (CV-05)"
                makeEditable('equipment-field', 'select',
                    EQUIPMENTS.map(e => `${e.name} (${e.code})`)
                );

                // Optional: Format datetime-local fields on load (if needed)
                document.querySelectorAll("span[id*='date'], span[id*='time']").forEach(span => {
                    const text = span.innerText.trim();
                    if (!text || text === '-') return;

                    const d = new Date(text);
                    if (isNaN(d)) return;

                    const pad = x => x.toString().padStart(2, '0');
                    const dtLocal = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    span.setAttribute('data-datetime-value', dtLocal); // Store for later use
                });

                document.getElementById('complaintForm').addEventListener('submit', function (e) {
                    // Update hidden inputs from current DOM values
                    document.querySelector('input[name="subject"]').value = document.getElementById('subject-field').innerText.trim();
                    document.querySelector('input[name="status"]').value = document.getElementById('status-field').innerText.trim();
                    document.querySelector('input[name="priority"]').value = document.getElementById('priority-field').innerText.trim();
                    document.querySelector('input[name="category"]').value = document.getElementById('category-field').innerText.trim();
                    document.querySelector('input[name="assignee"]').value = document.getElementById('assignee-field').innerText.trim();
                    document.querySelector('input[name="area"]').value = document.getElementById('area-field').innerText.trim();
                    document.querySelector('input[name="equipment"]').value = document.getElementById('equipment-field').innerText.trim();
                    document.querySelector('input[name="description"]').value = document.getElementById('description-field').value.trim();
                    document.querySelector('input[name="action_taken"]').value = document.getElementById('action-taken-field').value.trim();
                    document.querySelector('input[name="report_date"]').value = document.getElementById('report-date-field').getAttribute('data-original');
                    document.querySelector('input[name="close_time"]').value = document.getElementById('close-time-field').getAttribute('data-original');
                    document.querySelector('input[name="resolution_time"]').value = document.getElementById('resolution-time-field').getAttribute('data-original');
                    document.querySelector('input[name="updated_at"]').value = document.getElementById('updated-at-field').getAttribute('data-original');

                    // Serialize parts table
                    const parts = [];
                    document.querySelectorAll('#partsTable tbody tr').forEach(row => {
                        const cells = row.querySelectorAll('td');
                        parts.push({
                            code: cells[0].querySelector('code').textContent,
                            name: cells[1].textContent,
                            category: cells[2].textContent,
                            qty: cells[3].textContent.trim()
                        });
                    });
                    document.getElementById('partsUsedData').value = JSON.stringify(parts);
                });

                // Optional: Update hidden field on every change (real-time sync)
                function updateHiddenInput(selector, inputSelector) {
                    const field = document.querySelector(selector);
                    const input = document.querySelector(inputSelector);
                    if (field && input) {
                        field.addEventListener('blur', function () {
                            input.value = field.innerText.trim();
                        }, true);
                    }
                }

                // Call for all editable fields
                updateHiddenInput('#subject-field', 'input[name="subject"]');
                updateHiddenInput('#status-field', 'input[name="status"]');
                updateHiddenInput('#priority-field', 'input[name="priority"]');
                updateHiddenInput('#category-field', 'input[name="category"]');
                updateHiddenInput('#assignee-field', 'input[name="assignee"]');
                updateHiddenInput('#area-field', 'input[name="area"]');
                updateHiddenInput('#equipment-field', 'input[name="equipment"]');
            });
        </script>
    </th:block> -->
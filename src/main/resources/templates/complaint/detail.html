<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layouts/dashboard}">

<head>
    <title>Documents</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="panel-header">
            <div class="page-inner py-5">
                <div class="page-header">
                    <h4 class="page-title" th:text="${title}"></h4>
                    <ul class="breadcrumbs pt-4">
                        <li class="nav-home">
                            <p>
                                <i class="flaticon-home"></i>
                            </p>
                        </li>
                        <li class="separator">
                            <i class="flaticon-right-arrow"></i>
                        </li>
                        <li class="nav-item">
                            <p>Menu</p>
                        </li>
                        <li class="separator">
                            <i class="flaticon-right-arrow"></i>
                        </li>
                        <li class="nav-item">
                            <p th:text="${title}"></p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="page-inner mt--5">
            <div class="row">
                <div class="col-md-12 ml-auto mr-auto">
                    <div class="card card-profile">
                        <div class="card-body">
                            <!-- Header: ID & Status -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0 text-muted" id="complaint-key">COM-fX9aB2kLmN</h5>
                                <span class="badge badge-success text-uppercase" id="status-field" 
                                      style="cursor: pointer; font-weight: 600;" 
                                      title="Click to change status">
                                    CLOSED
                                </span>
                            </div>
                        
                            <!-- Subject (Editable) -->
                            <h3 class="mb-3" id="subject-field" 
                                contenteditable="true" 
                                data-original="Motor Overheating and Noise"
                                style="cursor: text; border-bottom: 2px dashed transparent; transition: border-color 0.2s;"
                                onfocus="this.style.borderBottom='2px dashed #007bff';"
                                onblur="this.style.borderBottom='2px dashed transparent';">
                                Motor Overheating and Noise
                            </h3>
                        
                            <!-- Badges: Type, Priority, Category -->
                            <div class="mb-4">
                                <span class="badge badge-info">Maintenance</span>
                                <span class="badge badge-danger" id="priority-field" 
                                      style="cursor: pointer;" 
                                      title="Click to edit">High Priority</span>
                                <span class="badge badge-dark" id="category-field" 
                                      style="cursor: pointer;" 
                                      title="Click to edit">Mechanical</span>
                            </div>
                        
                            <!-- Details Grid -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <strong>Reporter:</strong>
                                        <span id="reporter-field"
                                              data-original="John Doe (Operator)"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            John Doe (Operator)
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Assignee:</strong>
                                        <span id="assignee-field" contenteditable="true" 
                                              data-original="Alice (Maintenance)"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            Alice (Maintenance)
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Area:</strong>
                                        <span id="area-field" contenteditable="true" 
                                              data-original="Production Floor A"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            Production Floor A
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Machine:</strong>
                                        <span id="machine-field" contenteditable="true" 
                                              data-original="Conveyor-5"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            Conveyor-5
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <strong>Report Date:</strong>
                                        <span id="report-date-field"
                                              data-original="Apr 5, 2025 10:30"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            Apr 5, 2025 10:30
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Close Time:</strong>
                                        <span id="close-time-field"
                                              data-original="Apr 5, 2025 14:45"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            Apr 5, 2025 14:45
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Resolution Time:</strong>
                                        <span id="resolution-time-field"
                                              data-original="255 minutes"
                                              style="cursor: text; border-bottom: 1px dashed #ccc;">
                                            255 minutes
                                        </span>
                                    </p>
                                </div>
                            </div>
                        
                            <!-- Description -->
                            <div class="mb-4">
                                <h5 class="d-flex align-items-center mb-2">
                                    <i class="fas fa-align-left mr-2 text-primary"></i> Description
                                </h5>
                                <textarea 
                                    id="description-field" 
                                    class="form-control" 
                                    rows="6" 
                                    readonly
                                    data-original="The main drive motor is making loud grinding noise and temperature exceeds 90°C. Vibration levels are high during startup."
                                    style="background-color: #f9f9fb; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Segoe UI', sans-serif; cursor: pointer;"
                                    onclick="this.readOnly = false; this.style.backgroundColor = '#fff'; this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,.1)'; this.focus();">
The main drive motor is making loud grinding noise and temperature exceeds 90°C. Vibration levels are high during startup.
                                </textarea>
                            </div>
                        
                            <!-- Action Taken -->
                            <div class="mb-4">
                                <h5 class="d-flex align-items-center mb-2">
                                    <i class="fas fa-wrench mr-2 text-success"></i> Action Taken
                                </h5>
                                <textarea 
                                    id="action-taken-field" 
                                    class="form-control" 
                                    rows="6" 
                                    readonly
                                    data-original="Replaced AC motor (MTR-2001) and two ball bearings (BRG-8890). Realigned coupling and tested under load for 1 hour."
                                    style="background-color: #f9f9fb; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Segoe UI', sans-serif; cursor: pointer;"
                                    onclick="this.readOnly = false; this.style.backgroundColor = '#fff'; this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,.1)'; this.focus();">
Replaced AC motor (MTR-2001) and two ball bearings (BRG-8890). Realigned coupling and tested under load for 1 hour.
                                </textarea>
                            </div>
                        
                            <!-- Parts Used -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="d-flex align-items-center mb-0">
                                        <i class="fas fa-cogs mr-2 text-secondary"></i> Parts Used
                                    </h5>
                                    <button type="button" class="btn btn-primary btn-sm btn-round" id="addPartBtn">
                                        <i class="fas fa-plus"></i> Add Part
                                    </button>
                                </div>
                            
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm rounded overflow-hidden" id="partsTable">
                                        <thead class="thead-light" style="background-color: #f8f9fa;">
                                            <tr>
                                                <th class="pl-3">Part Code</th>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th class="text-center">Qty</th>
                                                <th class="text-center" style="width: 80px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="pl-3"><code class="bg-light px-2 py-1 rounded">MTR-2001</code></td>
                                                <td>AC Motor 1.5kW</td>
                                                <td>Mechanical</td>
                                                <td class="text-center font-weight-bold" contenteditable="true" data-original="1">1</td>
                                                <td class="text-center">
                                                    <button class="btn btn-link text-danger btn-sm delete-row"><i class="fas fa-trash-alt"></i></button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="pl-3"><code class="bg-light px-2 py-1 rounded">BRG-8890</code></td>
                                                <td>Ball Bearing 6205</td>
                                                <td>Mechanical</td>
                                                <td class="text-center font-weight-bold" contenteditable="true" data-original="2">2</td>
                                                <td class="text-center">
                                                    <button class="btn btn-link text-danger btn-sm delete-row"><i class="fas fa-trash-alt"></i></button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-4">
                                <small class="text-muted">
                                    Last updated: 
                                    <span id="updated-at-field" contenteditable="true" 
                                          data-original="Apr 5, 2025 14:45"
                                          style="font-weight: 500;">
                                        Apr 5, 2025 14:45
                                    </span>
                                </small>
                                <div>
                                    <button type="button" class="btn btn-danger btn-border btn-round mr-2" data-toggle="modal" data-target="#deleteConfirmModal">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                    <button type="button" class="btn btn-primary btn-round" id="saveChangesBtn">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Fragment -->
    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener("DOMContentLoaded", function () {

                function makeTextareaEditable(fieldId) {
                    const textarea = document.getElementById(fieldId);
                    if (!textarea) return;

                    // Style when readonly (static appearance)
                    const readonlyStyle = {
                        backgroundColor: '#f8f9fa',
                        border: '1px solid #ddd',
                        opacity: '0.8',
                        cursor: 'pointer'
                    };

                    // Style when editing
                    const editingStyle = {
                        backgroundColor: '#fff',
                        border: '1px solid #007bff',
                        opacity: '1',
                        boxShadow: '0 0 0 0.2rem rgba(0,123,255,.1)'
                    };

                    // Apply readonly visual style
                    Object.assign(textarea.style, readonlyStyle);

                    textarea.addEventListener('click', function () {
                        if (textarea.readOnly) {
                            // Enable editing
                            textarea.readOnly = false;
                            Object.assign(textarea.style, editingStyle);
                            textarea.focus();
                        }
                    });

                    // Save on blur
                    textarea.addEventListener('blur', function () {
                        const original = textarea.getAttribute('data-original');
                        const current = textarea.value.trim();

                        if (current !== original) {
                            console.log(`Updated: ${fieldId} → "${original}" → "${current}"`);
                            // Here you can send update via AJAX
                            // Example: fetch('/api/update-complaint', { method: 'POST', body: JSON.stringify({ field: fieldId, value: current }) })
                            textarea.setAttribute('data-original', current);
                        }

                        // Reapply readonly state and style
                        textarea.readOnly = true;
                        Object.assign(textarea.style, readonlyStyle);
                    });

                    // Allow Enter to save, Escape to cancel
                    textarea.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            // Ctrl+Enter to save
                            textarea.blur();
                        } else if (e.key === 'Escape') {
                            // Revert to original value
                            textarea.value = textarea.getAttribute('data-original');
                            textarea.blur();
                        }
                    });
                }

                // Initialize editable textareas
                makeTextareaEditable('description-field');
                makeTextareaEditable('action-taken-field');

                // Function to turn field into input on click
                function makeEditable(fieldId, type = 'text', options = null, dynamicOptionsFn = null) {
                    const field = document.getElementById(fieldId);
                    if (!field) return;

                    const originalValue = field.getAttribute('data-original') || field.innerText.trim();
                    field.setAttribute('data-original', originalValue);
                    let input;

                    field.style.cursor = 'pointer';
                    field.title = 'Click to edit';

                    field.addEventListener('click', function (e) {
                        if (field.querySelector('input, select')) return; // Already editing

                        let availableOptions = [];
                        if (dynamicOptionsFn && typeof dynamicOptionsFn === 'function') {
                            availableOptions = dynamicOptionsFn(field.innerText.trim());
                        } else {
                            availableOptions = Array.isArray(options) ? options : [];
                        }

                        if (availableOptions.length === 0) return;

                        input = document.createElement('select');
                        input.className = 'form-control form-control-sm';

                        availableOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === field.innerText.trim()) option.selected = true;
                            input.appendChild(option);
                        });

                        // 🔴 Apply badge-like styling to the select
                        const computedStyle = window.getComputedStyle(field);
                        input.style.backgroundColor = computedStyle.backgroundColor;
                        input.style.color = computedStyle.color;
                        input.style.borderColor = computedStyle.color;
                        input.style.borderWidth = '2px';
                        input.style.borderStyle = 'solid';
                        input.style.borderRadius = '0.25rem';
                        input.style.padding = '0.3em 0.6em';
                        input.style.fontSize = computedStyle.fontSize;
                        input.style.fontWeight = computedStyle.fontWeight;
                        input.style.height = 'auto';
                        input.style.minHeight = 'unset';

                        // Replace field content
                        field.innerHTML = '';
                        field.appendChild(input);
                        input.focus();
                    });

                    // Save on blur
                    field.addEventListener('blur', function (e) {
                        const target = e.relatedTarget || document.activeElement;
                        if (field.contains(target)) return; // Still in the field

                        const select = field.querySelector('select');
                        if (!select) return;

                        const newValue = select.options[select.selectedIndex].text;
                        const oldValue = field.getAttribute('data-original');

                        if (newValue && newValue !== oldValue) {
                            console.log(`Updated: ${fieldId} → "${oldValue}" → "${newValue}"`);
                            field.innerHTML = newValue;
                            field.setAttribute('data-original', newValue);

                            // Update badge class if applicable
                            if (field.classList.contains('badge')) {
                                field.className = getStatusBadgeClass(newValue); // Reapply correct badge class
                            }
                        } else {
                            field.innerHTML = oldValue;
                        }
                    }, true);

                    // Handle Enter and Escape
                    field.addEventListener('keydown', function (e) {
                        const select = field.querySelector('select');
                        if (!select) return;

                        if (e.key === 'Enter') {
                            e.preventDefault();
                            field.blur();
                        } else if (e.key === 'Escape') {
                            field.innerHTML = originalValue;
                        }
                    });
                }


                // Helper to get correct Bootstrap badge class
                function getStatusBadgeClass(status) {
                    switch (status) {
                        case 'OPEN': return 'badge badge-danger';
                        case 'INPROGRESS': return 'badge badge-primary';
                        case 'PENDING': return 'badge badge-warning';
                        case 'CLOSED': return 'badge badge-success';
                        default: return 'badge badge-secondary';
                    }
                }

                // Dynamic options generator for status-field
                function getStatusOptions(currentStatus) {
                    switch (currentStatus) {
                        case 'OPEN':
                            return ['OPEN', 'INPROGRESS'];
                        case 'INPROGRESS':
                            return ['INPROGRESS', 'PENDING', 'CLOSED'];
                        case 'PENDING':
                            return ['PENDING', 'INPROGRESS', 'CLOSED'];
                        case 'CLOSED':
                            return ['CLOSED', 'INPROGRESS'];
                        default:
                            return [];
                    }
                }

                // Initialize editable fields
                makeEditable('subject-field', 'text');
                makeEditable('status-field', 'select', null, getStatusOptions); // Dynamic options
                makeEditable('priority-field', 'select', ['Low Priority', 'Medium Priority', 'High Priority']);
                makeEditable('category-field', 'select', ['Mechanical', 'Electrical', 'Software', 'Safety']);
                makeEditable('assignee-field', 'select', ['Budi', 'Nina', 'Joko', 'Dono']);
                makeEditable('area-field', 'select', ['Budi', 'Nina', 'Joko', 'Dono']);
                makeEditable('machine-field', 'select', ['Budi', 'Nina', 'Joko', 'Dono']);

                // Optional: Format datetime-local fields on load (if needed)
                document.querySelectorAll("span[id*='date'], span[id*='time']").forEach(span => {
                    const text = span.innerText.trim();
                    if (!text || text === '-') return;

                    const d = new Date(text);
                    if (isNaN(d)) return;

                    const pad = x => x.toString().padStart(2, '0');
                    const dtLocal = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    span.setAttribute('data-datetime-value', dtLocal); // Store for later use
                });
            });
        </script>
    </th:block>

</body>

</html>
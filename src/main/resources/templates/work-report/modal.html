<div th:fragment="modal">
    <!-- Modal Add -->
    <div class="modal fade" id="addRowModal" tabindex="-1" role="dialog" aria-labelledby="addRowModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white no-bd">
                    <h5 class="modal-title" id="addRowModalLabel">Add New Report</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <form th:action="@{/reports}" method="post" id="formAdd">
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-control" id="addDate" name="date">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Shift</label>
                                    <select class="form-control" id="addShift" name="shift">
                                        <option value="Day">Day</option>
                                        <option value="Night">Night</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Machine Name</label>
                                    <input type="text" class="form-control" id="addMachine" name="machine">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Problem Description</label>
                            <textarea class="form-control" id="addProblemDescription" name="problemDescription"
                                rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Solution & Parts Replaced</label>
                            <textarea class="form-control" id="addSolutionParts" name="solutionParts"
                                rows="2"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" class="form-control" id="addStartTime" name="startTime">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Stop Time</label>
                                    <input type="time" class="form-control" id="addStopTime" name="stopTime">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Total Time</label>
                                    <input type="text" class="form-control" id="addTotalTime" name="totalTime"
                                        placeholder="e.g. 30 min" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Technician Name</label>
                                    <input type="text" class="form-control" id="addTechnicianName"
                                        name="technicianName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Supervisor</label>
                                    <input type="text" class="form-control" id="addSupervisor" name="supervisor">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" class="form-control" id="addCategory" name="category">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addStatus">Status</label>
                                    <select class="form-control" id="addStatus" name="status" required>
                                        <option value="" disabled selected>Select Status</option>
                                        <option value="PENDING">Pending</option>
                                        <option value="IN_PROGRESS">In Progress</option>
                                        <option value="DONE">Done</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a status.</div>
                                </div>
                            </div>
                            <!-- <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editComplaintCode">Complaint Code</label>
                                    <input type="text" class="form-control" id="addComplaintCode" name="complaintCode">
                                </div>
                            </div> -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-2 pb-4 px-4 d-flex justify-content-between">
                    <small class="text-muted">
                        <i class="fas fa-asterisk text-danger mr-1"></i> Required fields
                    </small>
                    <div>
                        <button type="button" class="btn btn-danger btn-border" data-dismiss="modal">Cancel</button>
                        <button type="submit" form="formAdd" class="btn btn-primary ml-2">Save Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div class="modal fade" id="editRowModal" tabindex="-1" role="dialog" aria-labelledby="editRowModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white no-bd">
                    <h5 class="modal-title" id="editRowModalLabel">Edit Report</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <form th:action="@{/reports/update}" method="post" id="formEdit">
                        <input type="hidden" name="id" id="editId">
                        <!-- Same fields as Add, prefixed with edit -->
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-control" id="editDate" name="date">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Shift</label>
                                    <select class="form-control" id="editShift" name="shift">
                                        <option value="Day">Day</option>
                                        <option value="Night">Night</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Machine Name</label>
                                    <input type="text" class="form-control" id="editMachineName" name="machineName">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Problem Description</label>
                            <textarea class="form-control" id="editProblemDescription" name="problemDescription"
                                rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Solution & Parts Replaced</label>
                            <textarea class="form-control" id="editSolutionParts" name="solutionParts"
                                rows="2"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" class="form-control" id="editStartTime" name="startTime">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Stop Time</label>
                                    <input type="time" class="form-control" id="editStopTime" name="stopTime">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Total Time</label>
                                    <input type="text" class="form-control" id="editTotalTime" name="totalTime"
                                        placeholder="e.g. 30 min" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Technician Name</label>
                                    <input type="text" class="form-control" id="editTechnicianName"
                                        name="technicianName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Supervisor</label>
                                    <input type="text" class="form-control" id="editSupervisor" name="supervisor">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" class="form-control" id="editCategory" name="category">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editStatus">Status</label>
                                    <select class="form-control" id="editStatus" name="status">
                                        <option value="" disabled selected>Select Status</option>
                                        <option value="PENDING">Pending</option>
                                        <option value="IN_PROGRESS">In Progress</option>
                                        <option value="DONE">Done</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a status.</div>
                                </div>
                            </div>
                            <!-- <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editComplaintCode">Complaint Code</label>
                                    <input type="text" class="form-control" id="editComplaintCode" name="complaintCode">
                                </div>
                            </div> -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-2 pb-4 px-4 d-flex justify-content-between">
                    <small class="text-muted">
                        <i class="fas fa-asterisk text-danger mr-1"></i> Required fields
                    </small>
                    <div>
                        <button type="button" class="btn btn-danger btn-border" data-dismiss="modal">Cancel</button>
                        <button type="submit" form="formEdit" class="btn btn-primary ml-2">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Delete -->
    <div class="modal fade" id="deleteRowModal" tabindex="-1" role="dialog" aria-labelledby="deleteRowModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white no-bd">
                    <h5 class="modal-title" id="deleteRowModalLabel">Delete Report</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <p>Are you sure you want to delete this report?</p>
                    <strong id="deleteDocName" class="text-dark"></strong>
                    <p class="text-muted mt-2 mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0 pt-2 pb-4 px-4">
                    <button type="button" class="btn btn-secondary btn-border" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger ml-2" id="confirmDeleteButton">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            // Helper: Convert time string (HH:MM) to minutes since midnight
            function timeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Helper: Convert minutes to HH:mm or "X min"
            function formatDuration(minutes) {
                if (minutes <= 0) return '';
                if (minutes < 60) {
                    return minutes + ' min';
                }
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return m > 0 ? `${h}h ${m}min` : `${h}h`;
            }

            // Auto-calculate Total Time for Add Modal
            function calculateAddTotalTime() {
                const start = $('#addStartTime').val();
                const end = $('#addStopTime').val();
                if (start && end) {
                    const startMins = timeToMinutes(start);
                    const endMins = timeToMinutes(end);
                    let diff = endMins - startMins;
                    if (diff < 0) diff = 0; // Prevent negative
                    $('#addTotalTime').val(formatDuration(diff));
                } else {
                    $('#addTotalTime').val('');
                }
            }

            // Auto-calculate Total Time for Edit Modal
            function calculateEditTotalTime() {
                const start = $('#editStartTime').val();
                const end = $('#editStopTime').val();
                if (start && end) {
                    const startMins = timeToMinutes(start);
                    const endMins = timeToMinutes(end);
                    let diff = endMins - startMins;
                    if (diff < 0) diff = 0;
                    $('#editTotalTime').val(formatDuration(diff));
                } else {
                    $('#editTotalTime').val('');
                }
            }

            // Attach event listeners
            $('#addStartTime, #addStopTime').on('change', calculateAddTotalTime);
            $('#editStartTime, #editStopTime').on('change', calculateEditTotalTime);

            // Recalculate when modal opens (in case values are pre-filled)
            $('#addRowModal').on('shown.bs.modal', calculateAddTotalTime);
            $('#editRowModal').on('shown.bs.modal', calculateEditTotalTime);
        });
    </script>
</div>
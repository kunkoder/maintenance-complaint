<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/dashboard}">

<head>
	<title>Dashboard</title>
</head>

<body>
	<div layout:fragment="content">
		<div class="panel-header bg-primary-gradient">
			<div class="page-inner py-5">
				<div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
					<div>
						<h2 class="text-white pb-2 fw-bold">Dashboard</h2>
						<h5 class="text-white op-7 mb-2">Maintenance Overview</h5>
					</div>
					<div class="ml-md-auto py-2 py-md-0">
						<a href="#" class="btn btn-info btn-round" id="generateReportBtn">
							<i class="fas fa-file-pdf"></i> Generate Report
						</a>
					</div>
				</div>
			</div>
		</div>
		<div class="page-inner mt--5">
			<div class="row">
				<div class="col-md-12">
					<div class="card full-height">
						<!-- Card Header with Title and Filter -->
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<h4 class="card-title">Overall Ticket Statistics</h4>
								<!-- Date Range Filter in Header -->
								<form id="dateRangeForm1" class="form-inline">
									<div class="input-group input-daterange">
										<input type="datetime-local" class="form-control form-control-sm" id="from1"
											name="from" required>
										<div class="input-group-prepend input-group-append">
											<span class="input-group-text">to</span>
										</div>
										<input type="datetime-local" class="form-control form-control-sm" id="to1"
											name="to" required>
										<div class="input-group-append">
											<button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
										</div>
									</div>
								</form>
							</div>
						</div>

						<!-- Card Body with 4 Stat Cards in Grid -->
						<div class="card-body">
							<div class="row row-card-no-pd mb-0" style="box-shadow: none;">
								<!-- 1. Total Tickets -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-primary card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-ticket-alt text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Total Tickets</p>
														<h4 class="card-title" id="totalAllComplaints">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 2. Total Pending -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-danger card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-clock text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Total Pending</p>
														<h4 class="card-title" id="totalPending">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 3. Open Today -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-warning card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-folder-open text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Open Today</p>
														<h4 class="card-title" id="totalOpen">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 4. Closed Today -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-success card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-check-circle text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Closed Today</p>
														<h4 class="card-title" id="totalClosed">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Chart Card -->
			<div class="row">
    <div class="col-md-12">
        <div class="card full-height">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Daily Ticket Summary</h4>
                    <!-- Date Range Filter + Quick Buttons -->
                    <form id="dateRangeForm2" class="form-inline">
                        <div class="input-group input-daterange mr-2">
                            <input type="datetime-local" class="form-control form-control-sm" id="from2" name="from" required>
                            <div class="input-group-prepend input-group-append">
                                <span class="input-group-text">to</span>
                            </div>
                            <input type="datetime-local" class="form-control form-control-sm" id="to2" name="to" required>
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
                            </div>
                        </div>

                        <!-- Quick Range Buttons -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" data-range="weekly">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" data-range="monthly">Monthly</button>
                            <button type="button" class="btn btn-outline-primary" data-range="yearly">Yearly</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-container flex-grow-1">
                    <canvas id="multipleBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

			<div class="row">
				<div class="col-md-8">
					<div class="card">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Engineers Responsibility</h4>
								<div class="card-tools">
									<!-- Previous Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="prevEngineerBtn"
										title="Previous">
										<i class="fas fa-chevron-left"></i>
									</button>

									<!-- Next Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="nextEngineerBtn"
										title="Next">
										<i class="fas fa-chevron-right"></i>
									</button>

									<!-- Refresh Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="refreshEngineerBtn"
										title="Refresh">
										<i class="fa fa-sync-alt"></i>
									</button>
								</div>
							</div>
							<p class="card-category">Map of the distribution of engineers responsibility</p>
						</div>
						<div class="card-body">
							<div class="table-responsive table-hover table-sales">
								<table class="table table-bordered text-center">
									<thead class="bg-primary text-white">
										<tr>
											<th rowspan="2" class="align-middle">Engineer</th>
											<th id="openHeader" colspan="3">Open</th>
											<th id="pendingHeader" colspan="3">Pending</th>
											<th id="closedHeader" colspan="3">Closed</th>
										</tr>
										<tr id="dayHeaders">
											<!-- Day headers will be injected here -->
										</tr>
									</thead>
									<tbody id="engineerTableBody">
										<!-- Rows will be injected here -->
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<!-- Top Area -->
					<div class="card">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Equipment</h4>
								<div class="card-tools">
									<!-- Previous Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="prevEquipmentBtn"
										title="Previous">
										<i class="fas fa-chevron-up"></i>
									</button>

									<!-- Next Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="nextEquipmentBtn"
										title="Next">
										<i class="fas fa-chevron-down"></i>
									</button>

									<!-- Refresh Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="refreshEquipmentBtn"
										title="Refresh">
										<i class="fa fa-sync-alt"></i>
									</button>
								</div>
							</div>
							<p class="card-category">Most equipment breakdowns</p>
						</div>
						<div class="card-body pb-0" id="equipmentListContainer">
							<!-- Dynamic list will be injected here -->
						</div>
					</div>
				</div>

			</div>

		</div>

		<footer class="footer">
			<div class="container-fluid">
				<nav class="pull-left">
					<ul class="nav">
						<li class="nav-item">
							<a class="nav-link" href="https://www.themekita.com">
								ThemeKita
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">
								Help
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">
								Licenses
							</a>
						</li>
					</ul>
				</nav>
				<div class="copyright ml-auto">
					2018, made with <i class="fa fa-heart heart text-danger"></i> by <a
						href="https://www.themekita.com">ThemeKita</a>
				</div>
			</div>
		</footer>
	</div>

	<!-- Scripts Fragment -->
	<th:block layout:fragment="scripts">
		<script th:inline="javascript">
			/*<![CDATA[*/
			const baseUrl = /*[[${@environment.getProperty('server.servlet.context-path', '')}]]*/ '' || '';
			const apiEndpoint = baseUrl + '/api/dashboards/status-count';
			/*]]>*/
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<!-- <script th:src="@{/js/document-modal.js}"></script> -->

		<script>
			// Set default dates: today
			function setDefaultDates() {
				const now = new Date();
				const startOfDay = new Date(now);
				startOfDay.setHours(0, 0, 0, 0);

				const endOfDay = new Date(now);
				endOfDay.setHours(23, 59, 59, 999);

				document.getElementById('from').value = toDateTimeLocal(startOfDay);
				document.getElementById('to').value = toDateTimeLocal(endOfDay);
			}

			// Helper: format date for datetime-local input
			function toDateTimeLocal(date) {
				const pad = (n) => n.toString().padStart(2, '0');
				const year = date.getFullYear();
				const month = pad(date.getMonth() + 1);
				const day = pad(date.getDate());
				const hours = pad(date.getHours());
				const minutes = pad(date.getMinutes());
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			}

			// Fetch dashboard data
			function fetchDashboardData(from, to) {
				let url = `${baseUrl}/api/dashboards/status-count`;
				const params = new URLSearchParams();

				if (from) params.append('from', from);
				if (to) params.append('to', to);

				if (params.toString()) {
					url += '?' + params.toString();
				}

				fetch(url)
					.then(response => {
						if (!response.ok) throw new Error('Network error');
						return response.json();
					})
					.then(data => {
						// Update card values
						document.getElementById('totalAllComplaints').textContent = data.totalAllComplaints || 0;
						document.getElementById('totalOpen').textContent = data.totalOpen || 0;
						document.getElementById('totalClosed').textContent = data.totalClosed || 0;
						document.getElementById('totalPending').textContent = data.totalPending || 0;
					})
					.catch(err => {
						console.error('Fetch error:', err);
						alert('Failed to load dashboard data.');
					});
			}

			// Form submit
			document.getElementById('dateRangeForm1').addEventListener('submit', function (e) {
				e.preventDefault();
				const from = document.getElementById('from1').value;
				const to = document.getElementById('to1').value;
				fetchDashboardData(from, to);
			});

			// On page load: set defaults and load data
			window.addEventListener('DOMContentLoaded', function () {
				setDefaultDates();
				const from = document.getElementById('from1').value;
				const to = document.getElementById('to1').value;
				fetchDashboardData(from, to);
			});
		</script>
		<script>
    let myMultipleBarChart = null; // Hold chart instance
    const now = new Date();

    // Format date for datetime-local input
    function toDateTimeLocal(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Format short date for chart labels (e.g., "Jul 1")
    function formatLabel(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Set date range and update chart
    function setRange(from, to) {
        document.getElementById('from2').value = toDateTimeLocal(from);
        document.getElementById('to2').value = toDateTimeLocal(to);
        updateChart();
    }

    // Fetch and update chart
    function updateChart() {
        const from = document.getElementById('from2').value;
        const to = document.getElementById('to2').value;

        let url = `${baseUrl}/api/dashboards/daily-status-count`;
        const params = new URLSearchParams();
        if (from) params.append('from', from);
        if (to) params.append('to', to);
        if (params.toString()) url += '?' + params.toString();

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch data');
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (!data || data.length === 0) {
                    console.warn("No data returned");
                    return;
                }

                const labels = data.map(row => formatLabel(row.date));
                const openData = data.map(row => row.open);
                const closedData = data.map(row => row.closed);
                const pendingData = data.map(row => row.pending);

                const stackedMax = Math.max(...data.map(row => row.open + row.closed + row.pending));
                const yAxisMax = Math.ceil(stackedMax * 1.1);

                // Destroy old chart
                if (myMultipleBarChart) {
                    myMultipleBarChart.destroy();
                }

                const ctx = document.getElementById('multipleBarChart').getContext('2d');
                myMultipleBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Open",
                                backgroundColor: '#fdaf4b',
                                borderColor: '#fdaf4b',
                                borderWidth: 1,
                                data: openData
                            },
                            {
                                label: "Closed",
                                backgroundColor: '#59d05d',
                                borderColor: '#59d05d',
                                borderWidth: 1,
                                data: closedData
                            },
                            {
                                label: "Pending",
                                backgroundColor: '#d9534f',
                                borderColor: '#d9534f',
                                borderWidth: 1,
                                data: pendingData
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        legend: {
                            position: 'bottom',
                            labels: { fontColor: '#333', fontSize: 12 }
                        },
                        title: {
                            display: true,
                            text: 'Daily Ticket Summary',
                            fontColor: '#333',
                            fontSize: 16
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFontColor: '#fff'
                        },
                        scales: {
                            xAxes: [{
                                stacked: true,
                                gridLines: { display: false },
                                ticks: { fontColor: '#333' }
                            }],
                            yAxes: [{
                                stacked: true,
                                gridLines: { color: 'rgba(0,0,0,0.05)' },
                                ticks: {
                                    beginAtZero: true,
                                    stepSize: 5,
                                    max: Math.max(10, yAxisMax)
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Number of Tickets',
                                    fontColor: '#333'
                                }
                            }]
                        },
                        animation: { duration: 1000 }
                    }
                });
            })
            .catch(err => {
                console.error('Error loading chart data:', err);
                alert('Failed to load ticket data.');
            });
    }

    // Quick range buttons
    document.querySelectorAll('[data-range]').forEach(button => {
        button.addEventListener('click', () => {
            const now = new Date();
            let from = new Date(now);
            let to = new Date(now);

            switch (button.getAttribute('data-range')) {
                case 'weekly':
                    from.setDate(now.getDate() - 6);
                    break;
                case 'monthly':
                    from.setDate(1); // First day of current month
                    from.setHours(0, 0, 0, 0);
                    break;
                case 'yearly':
                    from = new Date(now.getFullYear(), 0, 1); // Jan 1 of current year
                    from.setHours(0, 0, 0, 0);
                    break;
            }

            setRange(from, to);
        });
    });

    // Form submission
    document.getElementById('dateRangeForm2').addEventListener('submit', function (e) {
        e.preventDefault();
        updateChart();
    });

    // On load: set weekly default and load data
    window.addEventListener('DOMContentLoaded', function () {
        const now = new Date();
        const from = new Date(now);
        from.setDate(now.getDate() - 6);
        document.getElementById('from2').value = toDateTimeLocal(from);
        document.getElementById('to2').value = toDateTimeLocal(now);
        updateChart();
    });
</script>
		<script>
			// Hold current date range
			let currentFrom = null;
			let currentTo = null;

			// Format date for input & API
			function toDateTimeLocal(date) {
				const pad = (n) => n.toString().padStart(2, '0');
				const year = date.getFullYear();
				const month = pad(date.getMonth() + 1);
				const day = pad(date.getDate());
				const hours = pad(date.getHours());
				const minutes = pad(date.getMinutes());
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			}

			// Format date for display: "Aug 10"
			function formatShort(dateStr) {
				const d = new Date(dateStr);
				return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
			}

			// Fetch and render data
			function fetchEngineerData(from = null, to = null) {
				let url = `${baseUrl}/api/dashboards/assignee-daily-status`;
				if (from && to) {
					url += `?from=${from}&to=${to}`;
				}

				fetch(url)
					.then(res => res.json())
					.then(data => {
						// Update current range
						currentFrom = data.dates[0];
						currentTo = data.dates[data.dates.length - 1];

						// Update headers
						const dayHeaderRow = document.getElementById('dayHeaders');
						dayHeaderRow.innerHTML = '';

						// // Update colspan
						// document.getElementById('openHeader').colSpan = numDays;
						// document.getElementById('pendingHeader').colSpan = numDays;
						// document.getElementById('closedHeader').colSpan = numDays;

						// // Generate and append day headers for each section
						// [...Array(3)].forEach(() => {
						// 	createDayThs(data.dates).forEach(th => dayHeaderRow.appendChild(th));
						// });

						const numDays = data.dates.length;

						// Helper: create day headers (Day 1, Day 2, ...)
						function createDayThs(dateArray, offset = 0) {
							const ths = [];
							for (let i = 0; i < dateArray.length; i++) {
								const th = document.createElement('th');
								th.textContent = `${formatShort(dateArray[i])}`;
								// th.textContent = `Day ${i + 1}\n(${formatShort(dateArray[i])})`;
								th.style.whiteSpace = 'pre-line';
								ths.push(th);
							}
							return ths;
						}

						// Append: Open (3 days)
						const openThs = createDayThs(data.dates);
						openThs.forEach(th => dayHeaderRow.appendChild(th));

						// Append: Pending (3 days)
						const pendingThs = createDayThs(data.dates);
						pendingThs.forEach(th => dayHeaderRow.appendChild(th));

						// Append: Closed (3 days)
						const closedThs = createDayThs(data.dates);
						closedThs.forEach(th => dayHeaderRow.appendChild(th));

						// Update body
						const tbody = document.getElementById('engineerTableBody');
						tbody.innerHTML = '';

						data.data.forEach(row => {
							const tr = document.createElement('tr');
							tr.innerHTML = `
          <td class="text-left fw-bold">${row.assignee}</td>
          ${row.open.map(v => `<td>${v}</td>`).join('')}
          ${row.pending.map(v => `<td>${v}</td>`).join('')}
          ${row.closed.map(v => `<td>${v}</td>`).join('')}
        `;
							tbody.appendChild(tr);
						});
					})
					.catch(err => {
						console.error('Failed to load engineer data:', err);
						alert('Could not load data.');
					});
			}

			// Helper: shift range by offset (in days)
			function shiftRange(offsetDays) {
				if (!currentFrom || !currentTo) return;

				const from = new Date(currentFrom);
				const to = new Date(currentTo);

				const daysDiff = Math.ceil((to - from) / (1000 * 60 * 60 * 24)); // number of days

				const newFrom = new Date(from);
				newFrom.setDate(newFrom.getDate() + offsetDays);
				const newTo = new Date(to);
				newTo.setDate(newTo.getDate() + offsetDays);

				const fromStr = toDateTimeLocal(newFrom).slice(0, 16); // '2025-08-10T00:00'
				const toStr = toDateTimeLocal(newTo).slice(0, 16);

				fetchEngineerData(fromStr, toStr);
			}

			// Buttons
			document.getElementById('prevEngineerBtn').addEventListener('click', () => {
				shiftRange(-1); // shift backward by 1 day window size
			});

			document.getElementById('nextEngineerBtn').addEventListener('click', () => {
				shiftRange(1); // shift forward
			});

			document.getElementById('refreshEngineerBtn').addEventListener('click', () => {
				currentFrom = null;
				currentTo = null;
				fetchEngineerData(); // default range
			});

			// On load: fetch default
			window.addEventListener('DOMContentLoaded', () => {
				fetchEngineerData(); // initial load
			});
		</script>
		<script>
			const API_URL = `${baseUrl}/api/dashboards/equipment-complaint-count`;

			let currentPage = 1; // 1 = first page (1-7), 2 = second page (8-14)
			const pageSize = 7;
			let allData = [];

			// Fetch data
			async function fetchEquipmentData() {
				try {
					const response = await fetch(API_URL);
					if (!response.ok) throw new Error('Failed to fetch data');
					allData = await response.json();
					renderPage(currentPage);
				} catch (err) {
					console.error('Error loading equipment data:', err);
					document.getElementById('equipmentListContainer').innerHTML = `
						<div class="text-center text-muted">Failed to load data</div>
					`;
				}
			}

			// Render current page
			function renderPage(page) {
				const container = document.getElementById('equipmentListContainer');
				container.innerHTML = '';

				const start = (page - 1) * pageSize;
				const end = start + pageSize;
				const pageData = allData.slice(start, end);

				if (pageData.length === 0) {
					container.innerHTML = `<div class="text-center text-muted">No data</div>`;
					return;
				}

				pageData.forEach((item, index) => {
					const rank = start + index + 1;
					const div = document.createElement('div');
					div.className = 'd-flex';
					div.innerHTML = `
  <div class="mr-3 d-flex align-items-center" style="min-width: 28px;">
    <span class="fw-bold" style="font-size: 0.95rem; color: #555; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      ${rank}
    </span>
  </div>
  <div class="flex-1 pt-1 ml-2">
    <h6 class="fw-bold mb-1">${item.equipmentCode}</h6>
    <small class="text-muted">${item.equipmentName}</small>
  </div>
  <div class="d-flex ml-auto align-items-center">
    <h3 class="text-info fw-bold">${item.totalComplaints}</h3>
  </div>
`;
					container.appendChild(div);

					// Add separator after each item (including before last)
					const sep = document.createElement('div');
					sep.className = 'separator-dashed';
					container.appendChild(sep);
				});
			}

			// Button Listeners
			document.getElementById('nextEquipmentBtn').addEventListener('click', () => {
				if (allData.length > currentPage * pageSize) {
					currentPage++;
					renderPage(currentPage);
				}
			});

			document.getElementById('prevEquipmentBtn').addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--;
					renderPage(currentPage);
				}
			});

			document.getElementById('refreshEquipmentBtn').addEventListener('click', () => {
				currentPage = 1;
				renderPage(currentPage);
			});

			// On Load
			window.addEventListener('DOMContentLoaded', () => {
				fetchEquipmentData();
			});
		</script>
		<script>
			document.getElementById('generateReportBtn').addEventListener('click', async function (e) {
				e.preventDefault();

				const { jsPDF } = window.jspdf;
				const btn = document.getElementById('generateReportBtn');
				const originalText = btn.innerHTML;
				btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
				btn.disabled = true;

				try {
					const pdf = new jsPDF('p', 'mm', 'a4');
					const pageWidth = pdf.internal.pageSize.getWidth();
					let y = 15;

					// Add Title
					pdf.setFontSize(20);
					pdf.setTextColor(40);
					pdf.text('Maintenance Dashboard Report', 14, y);
					y += 10;

					// Add Subtitle
					pdf.setFontSize(12);
					pdf.setTextColor(100);
					const now = new Date().toLocaleString();
					pdf.text(`Generated on: ${now}`, 14, y);
					y += 15;

					// List of elements to capture (excluding equipment)
					const sections = [
						{ element: document.querySelector('.card.full-height .card-body'), title: 'Overall Ticket Statistics', scale: 2 },
						{ element: document.querySelector('#multipleBarChart'), title: 'Daily Ticket Summary', scale: 2 },
						{ element: document.querySelector('.card .table-responsive'), title: 'Engineers Responsibility', scale: 1.5 }
					];

					// Capture all sections except equipment
					for (const section of sections) {
						if (!section.element) continue;

						if (y + 30 > 280) {
							pdf.addPage();
							y = 20;
						}
						pdf.setFontSize(14);
						pdf.setTextColor(60);
						pdf.text(section.title, 14, y);
						y += 8;

						const canvas = await html2canvas(section.element, {
							scale: section.scale,
							useCORS: true,
							backgroundColor: '#fff',
							logging: false,
							width: section.element.scrollWidth,
							height: section.element.scrollHeight
						});

						const imgData = canvas.toDataURL('image/png');
						const imgWidth = pageWidth - 28;
						const imgHeight = (canvas.height * imgWidth) / canvas.width;

						if (y + imgHeight > 280) {
							pdf.addPage();
							y = 20;
						}

						pdf.addImage(imgData, 'PNG', 14, y, imgWidth, imgHeight);
						y += imgHeight + 10;
					}

					// --- ✅ FIXED & BALANCED: Top Equipment Breakdowns ---
					{
						const tempContainer = document.createElement('div');
						tempContainer.style.fontFamily = 'Arial, sans-serif';
						tempContainer.style.fontSize = '11px';
						tempContainer.style.width = '400px';
						tempContainer.style.padding = '10px';
						tempContainer.style.backgroundColor = '#ffffff';
						tempContainer.style.boxSizing = 'border-box';

						const table = document.createElement('table');
						table.style.width = '100%';
						table.style.borderCollapse = 'collapse';

						// Header
						const thead = `
    <tr>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">#</th>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Code</th>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Name</th>
      <th style="text-align: right; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Count</th>
    </tr>
  `;
						table.innerHTML = `<thead>${thead}</thead><tbody></tbody>`;

						const tbody = table.querySelector('tbody');

						// ✅ Only get divs that contain real equipment data
						const allDivs = Array.from(document.querySelectorAll('#equipmentListContainer > div'));
						const validItems = [];

						allDivs.forEach(div => {
							const code = div.querySelector('h6');
							const name = div.querySelector('small');
							if (code && name && code.textContent.trim() && name.textContent.trim()) {
								validItems.push({
									code: code.textContent.trim(),
									name: name.textContent.trim(),
									count: (div.querySelector('.text-info')?.textContent || '0').trim()
								});
							}
						});

						// ✅ Now map with correct ranking
						validItems.forEach((item, index) => {
							const rank = index + 1;
							const row = document.createElement('tr');
							row.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';

							row.innerHTML = `
      <td style="padding: 4px 5px; font-weight: bold; color: #333; font-size: 7px;">${rank}</td>
      <td style="padding: 4px 5px; font-weight: bold; color: #000; font-size: 7px;">${item.code}</td>
      <td style="padding: 4px 5px; color: #555; font-size: 7px;">${item.name}</td>
      <td style="padding: 4px 5px; text-align: right; font-weight: bold; color: #007bff; font-size: 7px;">${item.count}</td>
    `;

							tbody.appendChild(row);
						});

						if (validItems.length === 0) {
							const row = document.createElement('tr');
							row.innerHTML = `<td colspan="4" style="padding: 10px; text-align: center; color: #999; font-size: 10px;">No data</td>`;
							tbody.appendChild(row);
						}

						tempContainer.appendChild(table);

						// Hide from view
						tempContainer.style.position = 'absolute';
						tempContainer.style.left = '-9999px';
						tempContainer.style.top = '-9999px';
						document.body.appendChild(tempContainer);

						try {
							const canvas = await html2canvas(tempContainer, {
								scale: 2,
								backgroundColor: '#fff'
							});
							document.body.removeChild(tempContainer);

							const imgData = canvas.toDataURL('image/png');
							const imgWidth = pageWidth - 28;
							const imgHeight = (canvas.height * imgWidth) / canvas.width;

							if (y + imgHeight > 280) {
								pdf.addPage();
								y = 20;
							}

							pdf.addImage(imgData, 'PNG', 14, y, imgWidth, imgHeight);
							y += imgHeight + 10;
						} catch (err) {
							console.error('Failed to capture equipment list', err);
							document.body.removeChild(tempContainer);
							y += 30;
						}
					}
					// --- End of Equipment Section ---

					// Footer
					pdf.setFontSize(10);
					pdf.setTextColor(150);
					// pdf.text('Kaiadmin Dashboard - Clean, awesome, simple and modern', 14, y || 290);
					pdf.text(`Page 1`, pageWidth - 14, 290, { align: 'right' });

					// Save
					pdf.save(`Dashboard_Report_${new Date().toISOString().split('T')[0]}.pdf`);

				} catch (err) {
					console.error('PDF generation error:', err);
					alert('Failed to generate report. Some content may not support capture.');
				} finally {
					btn.innerHTML = originalText;
					btn.disabled = false;
				}
			});
		</script>
	</th:block>
</body>

</html>





<!-- <div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-header">
							<div class="card-head-row">
								<div class="card-title">Equipment Statistics</div>
								<div class="card-tools">
									<a href="#" class="btn btn-info btn-border btn-round btn-sm mr-2">
										<span class="btn-label">
											<i class="fa fa-pencil"></i>
										</span>
										Export
									</a>
									<a href="#" class="btn btn-info btn-border btn-round btn-sm">
										<span class="btn-label">
											<i class="fa fa-print"></i>
										</span>
										Print
									</a>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div class="chart-container" style="min-height: 375px">
								<canvas id="statisticsChart"></canvas>
							</div>
							<div id="myChartLegend"></div>
						</div>
					</div>
				</div>
			</div> -->


<!-- <div class="row mt--2">
				<div class="col-md-4">
					<div class="row">
						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-info bubble-shadow-small">
												<i class="fas fa-folder-open text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Open Tickets</p>
												<h4 class="card-title">124</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-success bubble-shadow-small">
												<i class="fas fa-check-circle text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Closed Tickets</p>
												<h4 class="card-title">843</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-warning bubble-shadow-small">
												<i class="fas fa-clock text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Pending Tickets</p>
												<h4 class="card-title">124</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-8">
					<div class="card full-height">
						<div class="card-header">
							<div class="card-title">Multiple Bar Chart</div>
						</div>
						<div class="card-body d-flex flex-column">
							<div class="chart-container flex-grow-1">
								<canvas id="multipleBarChart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div> -->
<!-- <div class="row">
				<div class="col-md-4">
					<div class="card full-height">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Overall Statistics</h4>
								<div class="card-tools">
									<button class="btn btn-icon btn-link btn-primary btn-xs btn-refresh-card"><span
											class="fa fa-sync-alt"></span></button>
								</div>
							</div>
							<p class="card-category">
								Daily information about complaint status</p>
						</div>
						<div class="card-body">
							<div class="d-flex flex-wrap justify-content-around pb-2 pt-5">
								<div class="px-2 pb-2 pb-md-0 text-center">
									<div id="circles-1"></div>
									<h6 class="fw-bold mt-1 mb-3">Closed</h6>
								</div>
								<div class="px-2 pb-2 pb-md-0 text-center">
									<div id="circles-2"></div>
									<h6 class="fw-bold mt-1 mb-3">Open</h6>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-8">
					<div class="card full-height">
						<div class="card-body">
							<div class="card-title">Complaints of The Week</div>
							<div class="row py-3">

								<div class="col-md-12">
									<div id="chart-container">
										<canvas id="totalIncomeChart" style="height: 300px;"></canvas>
									</div>
								</div>
								<div class="col-md-12 d-flex flex-row justify-content-around mt-3">
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-success op-8">Closed</h6>
										<h3 class="fw-bold">15</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-danger op-8">Open</h6>
										<h3 class="fw-bold">48</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-success op-8">In Progress</h6>
										<h3 class="fw-bold">15</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-danger op-8">Pending</h6>
										<h3 class="fw-bold">48</h3>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div> -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/dashboard}">

<head>
	<title>Dashboard</title>
</head>

<body>
	<div layout:fragment="content">
		<div class="panel-header bg-primary-gradient">
			<div class="page-inner py-5">
				<div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
					<div>
						<h2 class="text-white pb-2 fw-bold">Dashboard</h2>
						<h5 class="text-white op-7 mb-2">Maintenance Overview</h5>
					</div>
					<div class="ml-md-auto py-2 py-md-0">
						<a href="#" class="btn btn-info btn-round" id="generateReportBtn">
							<i class="fas fa-file-pdf"></i> Generate Report
						</a>
					</div>
				</div>
			</div>
		</div>
		<div class="page-inner mt--5">
			<div class="row">
				<div class="col-md-12">
					<div class="card full-height">
						<!-- Card Header with Title and Filter -->
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<h4 class="card-title">Overall Complaint</h4>
								<form id="complaint-stats-form" class="form-inline">
									<div class="input-group input-daterange">
										<input type="datetime-local" class="form-control form-control-sm"
											id="complaint-stats-from" name="from" required>
										<div class="input-group-prepend input-group-append">
											<span class="input-group-text">to</span>
										</div>
										<input type="datetime-local" class="form-control form-control-sm"
											id="complaint-stats-to" name="to" required>
										<div class="input-group-append">
											<button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
										</div>
									</div>
								</form>
							</div>
						</div>

						<!-- Card Body with 4 Stat Cards in Grid -->
						<div class="card-body">
							<div class="row row-card-no-pd mb-0" style="box-shadow: none;">
								<!-- 1. Total Complaints -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-primary card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-ticket-alt text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Total Complaints</p>
														<h4 class="card-title" id="complaint-stats-total">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 2. Total Pending -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-danger card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-clock text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Total Pending</p>
														<h4 class="card-title" id="complaint-stats-pending">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 3. Open Today -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-warning card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-folder-open text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Open</p>
														<h4 class="card-title" id="complaint-stats-open">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- 4. Closed Today -->
								<div class="col-sm-6 col-md-3">
									<div class="card card-stats card-success card-round mt-1">
										<div class="card-body">
											<div class="row">
												<div class="col-5">
													<div class="icon-big text-center">
														<i class="fas fa-check-circle text-white"></i>
													</div>
												</div>
												<div class="col-7 col-stats">
													<div class="numbers">
														<p class="card-category">Closed</p>
														<h4 class="card-title" id="complaint-stats-closed">--</h4>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Chart Card -->
			<div class="row">
				<div class="col-md-12">
					<div class="card full-height">
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<h4 class="card-title">Complaint Chart</h4>
								<!-- Complaint Chart Form -->
								<form id="complaint-chart-form" class="form-inline">
									<div class="input-group input-daterange mr-2">
										<input type="date" class="form-control form-control-sm" id="complaint-from"
											required>
										<div class="input-group-prepend input-group-append">
											<span class="input-group-text">to</span>
										</div>
										<input type="date" class="form-control form-control-sm" id="complaint-to"
											required>
										<div class="input-group-append">
											<button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
										</div>
									</div>
									<div class="btn-group btn-group-sm" role="group">
										<button type="button" class="btn btn-outline-primary"
											data-range="weekly">Weekly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="monthly">Monthly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="yearly">Yearly</button>
									</div>
									<div class="ml-2" id="complaint-year-selector" style="display: none;">
										<select id="complaint-year-select"
											class="form-control form-control-sm"></select>
									</div>
								</form>
							</div>
						</div>
						<div class="card-body d-flex flex-column">
							<div class="chart-container flex-grow-1">
								<canvas id="complaint-bar-chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-8">
					<div class="card">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Engineers Responsibility</h4>
								<div class="card-tools">
									<!-- Previous Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="prevEngineerBtn"
										title="Previous">
										<i class="fas fa-chevron-left"></i>
									</button>

									<!-- Next Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="nextEngineerBtn"
										title="Next">
										<i class="fas fa-chevron-right"></i>
									</button>

									<!-- Refresh Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="refreshEngineerBtn"
										title="Refresh">
										<i class="fa fa-sync-alt"></i>
									</button>
								</div>
							</div>
							<p class="card-category">Map of the distribution of engineers responsibility</p>
						</div>
						<div class="card-body">
							<div class="table-responsive table-hover table-sales">
								<table class="table table-bordered text-center">
									<thead class="bg-primary text-white">
										<tr>
											<th rowspan="2" class="align-middle">Engineer</th>
											<th id="openHeader" colspan="3">Open</th>
											<th id="pendingHeader" colspan="3">Pending</th>
											<th id="closedHeader" colspan="3">Closed</th>
										</tr>
										<tr id="dayHeaders">
											<!-- Day headers will be injected here -->
										</tr>
									</thead>
									<tbody id="engineerTableBody">
										<!-- Rows will be injected here -->
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<!-- Top Area -->
					<div class="card">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Equipment</h4>
								<div class="card-tools">
									<!-- Previous Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="prevEquipmentBtn"
										title="Previous">
										<i class="fas fa-chevron-up"></i>
									</button>

									<!-- Next Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="nextEquipmentBtn"
										title="Next">
										<i class="fas fa-chevron-down"></i>
									</button>

									<!-- Refresh Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs" id="refreshEquipmentBtn"
										title="Refresh">
										<i class="fa fa-sync-alt"></i>
									</button>
								</div>
							</div>
							<p class="card-category">Most equipment complained</p>
						</div>
						<div class="card-body pb-0" id="equipmentListContainer">
							<!-- Dynamic list will be injected here -->
						</div>
					</div>
				</div>

			</div>
			<div class="row">
				<div class="col-md-12">
					<div class="card full-height">
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<h4 class="card-title">Work Report Chart</h4>
								<!-- Work Report Chart Form -->
								<form id="work-report-chart-form" class="form-inline">
									<div class="input-group input-daterange mr-2">
										<input type="date" class="form-control form-control-sm" id="work-report-from"
											required>
										<div class="input-group-prepend input-group-append">
											<span class="input-group-text">to</span>
										</div>
										<input type="date" class="form-control form-control-sm" id="work-report-to"
											required>
										<div class="input-group-append">
											<button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
										</div>
									</div>
									<div class="btn-group btn-group-sm" role="group">
										<button type="button" class="btn btn-outline-primary"
											data-range="weekly">Weekly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="monthly">Monthly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="yearly">Yearly</button>
									</div>
									<div class="ml-2" id="work-report-year-selector" style="display: none;">
										<select id="work-report-year-select"
											class="form-control form-control-sm"></select>
									</div>
								</form>
							</div>
						</div>
						<div class="card-body d-flex flex-column">
							<div class="chart-container flex-grow-1">
								<canvas id="work-report-line-chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
    <div class="col-md-12">
        <div class="card full-height">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Work Report Chart</h4>
                    <!-- Work Report Chart Form -->
                    <form id="wr-chart-form" class="form-inline">
                        <div class="input-group input-daterange mr-2">
                            <input type="date" class="form-control form-control-sm" id="wr-from" required>
                            <div class="input-group-prepend input-group-append">
                                <span class="input-group-text">to</span>
                            </div>
                            <input type="date" class="form-control form-control-sm" id="wr-to" required>
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
                            </div>
                        </div>

                        <!-- Equipment Dropdown -->
                        <div class="mr-2">
                            <select id="wr-equipment" class="form-control form-control-sm" style="min-width: 180px;">
                                <option value="">All Equipment</option>
                            </select>
                        </div>

                        <!-- Quick Buttons -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" data-range="weekly">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" data-range="monthly">Monthly</button>
                            <button type="button" class="btn btn-outline-primary" data-range="yearly">Yearly</button>
                        </div>

                        <!-- Year Selector -->
                        <div class="ml-2" id="wr-year-selector" style="display: none;">
                            <select id="wr-year-select" class="form-control form-control-sm"></select>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-container flex-grow-1">
                    <canvas id="wr-equipment-line-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
			<div class="row">
				<div class="col-md-12">
					<div class="card full-height">
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<h4 class="card-title">Breakdown Chart</h4>
								<!-- Breakdown Chart Form -->
								<form id="breakdown-chart-form" class="form-inline">
									<div class="input-group input-daterange mr-2">
										<input type="date" class="form-control form-control-sm" id="breakdown-from"
											required>
										<div class="input-group-prepend input-group-append">
											<span class="input-group-text">to</span>
										</div>
										<input type="date" class="form-control form-control-sm" id="breakdown-to"
											required>
										<div class="input-group-append">
											<button type="submit" class="btn btn-sm btn-primary ml-2">Apply</button>
										</div>
									</div>
									<div class="btn-group btn-group-sm" role="group">
										<button type="button" class="btn btn-outline-primary"
											data-range="weekly">Weekly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="monthly">Monthly</button>
										<button type="button" class="btn btn-outline-primary"
											data-range="yearly">Yearly</button>
									</div>
									<div class="ml-2" id="breakdown-year-selector" style="display: none;">
										<select id="breakdown-year-select"
											class="form-control form-control-sm"></select>
									</div>
								</form>
							</div>
						</div>
						<div class="card-body d-flex flex-column">
							<div class="chart-container flex-grow-1">
								<canvas id="breakdown-line-chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<!-- Top Equipment -->
					<div class="card">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Equipment</h4>
								<div class="card-tools">
									<!-- Previous Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs"
										id="equipment-work-prev-btn" title="Previous">
										<i class="fas fa-chevron-up"></i>
									</button>
									<!-- Next Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs"
										id="equipment-work-next-btn" title="Next">
										<i class="fas fa-chevron-down"></i>
									</button>
									<!-- Refresh Button -->
									<button class="btn btn-icon btn-link btn-primary btn-xs"
										id="equipment-work-refresh-btn" title="Refresh">
										<i class="fa fa-sync-alt"></i>
									</button>
								</div>
							</div>
							<p class="card-category">Most equipment repaired</p>
						</div>
						<div class="card-body pb-0" id="equipment-work-list-container">
							<!-- Dynamic list will be injected here -->
						</div>
					</div>
				</div>
			</div>

			<script>
				function formatDate(date) {
					return date.toISOString().split('T')[0]; // YYYY-MM-DD
				}

				function toApiDateTime(dateStr, isEnd = false) {
					if (!dateStr) return '';
					const date = new Date(dateStr);
					if (isEnd) {
						date.setHours(23, 59, 59, 999); // 23:59:59.999
					} else {
						date.setHours(0, 0, 0, 0); // 00:00:00.000
					}
					return date.toISOString().slice(0, 16); // "2025-08-01T00:00"
				}

				// Populate year selector
				function populateYearSelector(selectId, selectedYear = null) {
					const select = document.getElementById(selectId);
					const currentYear = new Date().getFullYear();
					select.innerHTML = '';
					for (let y = currentYear - 10; y <= currentYear + 1; y++) {
						const opt = new Option(y, y);
						if (y === selectedYear || (selectedYear === null && y === currentYear)) {
							opt.selected = true;
						}
						select.appendChild(opt);
					}
				}
			</script>

			<script>
				let complaintChart = null;

				function updateComplaintChart(mode, from = null, to = null, year = null) {
					let url, labels = [], openData = [], closedData = [], pendingData = [];

					if (mode === 'yearly') {
						url = `/api/dashboards/monthly-complaint${year ? '?year=' + year : ''}`;
						fetch(url)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data) || data.length === 0) return;

								const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
									"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
								const labels = Array(12).fill('');
								const openData = Array(12).fill(0);
								const closedData = Array(12).fill(0);
								const pendingData = Array(12).fill(0);

								data.forEach(d => {
									const dateStr = d.date; // "2025-01"
									const monthIndex = parseInt(dateStr.split('-')[1]) - 1; // 0-based
									if (monthIndex >= 0 && monthIndex < 12) {
										labels[monthIndex] = months[monthIndex];
										openData[monthIndex] = d.open || 0;
										closedData[monthIndex] = d.closed || 0;
										pendingData[monthIndex] = d.pending || 0;
									}
								});

								// Fill missing months
								for (let i = 0; i < 12; i++) {
									if (!labels[i]) labels[i] = months[i];
								}

								renderComplaintChart(labels, openData, closedData, pendingData, 'Monthly Ticket Summary');
							})
							.catch(err => console.error('Monthly fetch error:', err));


					} else {
						const fromApi = toApiDateTime(from, false); // T00:00
						const toApi = toApiDateTime(to, true);     // T23:59
						url = `/api/dashboards/daily-complaint?from=${fromApi}&to=${toApi}`;

						fetch(url)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data)) return;
								console.log(data);
								// ✅ Use full date as label (API already returns correct range)
								labels = data.map(d => d.date); // e.g., "2025-08-27"
								openData = data.map(d => d.open || 0);
								closedData = data.map(d => d.closed || 0);
								pendingData = data.map(d => d.pending || 0);

								renderComplaintChart(labels, openData, closedData, pendingData, 'Daily Ticket Summary');
							});
					}
				}

				function renderComplaintChart(labels, open, closed, pending, title) {
					const ctx = document.getElementById('complaint-bar-chart').getContext('2d');
					if (complaintChart) complaintChart.destroy();

					// Combine all data to find max value
					const allData = [...open, ...closed, ...pending];
					const maxValue = Math.max(...allData, 0);
					const stackedValues = labels.map((_, i) => (open[i] || 0) + (closed[i] || 0) + (pending[i] || 0));
					const totalMax = Math.max(...stackedValues, 0);

					// Dynamic step size based on max value
					let stepSize;
					let maxTicks = 10; // Max number of ticks

					if (totalMax <= 20) {
						stepSize = 5;
					} else if (totalMax <= 50) {
						stepSize = 10;
					} else if (totalMax <= 100) {
						stepSize = 20;
					} else if (totalMax <= 200) {
						stepSize = 25;
					} else if (totalMax <= 500) {
						stepSize = 50;
					} else {
						stepSize = Math.ceil(totalMax / maxTicks / 10) * 10; // Round to nearest 10
					}

					// Ensure max axis is multiple of stepSize
					const yAxisMax = Math.ceil(totalMax / stepSize) * stepSize;

					complaintChart = new Chart(ctx, {
						type: 'bar',
						data: {
							labels: labels,
							datasets: [
								{ label: "Open", backgroundColor: '#fdaf4b', data: open },
								{ label: "Closed", backgroundColor: '#59d05d', data: closed },
								{ label: "Pending", backgroundColor: '#d9534f', data: pending }
							]
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							title: { display: true, text: title },
							scales: {
								x: { stacked: true },
								y: {
									stacked: true,
									beginAtZero: true,
									max: yAxisMax,
									ticks: {
										stepSize: stepSize,
										callback: function (value) {
											return value; // Show plain number
										}
									}
								}
							},
							plugins: {
								tooltip: {
									mode: 'index',
									intersect: false,
									callbacks: {
										label: function (context) {
											return `${context.dataset.label}: ${context.parsed.y}`;
										}
									}
								}
							}
						}
					});
				}


				function initComplaintChartForm() {
					const now = new Date();
					const from = new Date(now);
					from.setDate(now.getDate() - 6);

					document.getElementById('complaint-from').value = formatDate(from);
					document.getElementById('complaint-to').value = formatDate(now);

					// Populate year selector
					populateYearSelector('complaint-year-select', now.getFullYear());

					// Quick buttons
					document.querySelectorAll('#complaint-chart-form .btn[data-range]').forEach(btn => {
						btn.addEventListener('click', () => {
							const range = btn.getAttribute('data-range');
							const now = new Date();
							if (range === 'weekly') {
								document.getElementById('complaint-year-selector').style.display = 'none';
								const from = new Date(now);
								from.setDate(now.getDate() - 6);
								document.getElementById('complaint-from').value = formatDate(from);
								document.getElementById('complaint-to').value = formatDate(now);
								updateComplaintChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'monthly') {
								document.getElementById('complaint-year-selector').style.display = 'none';
								const from = new Date(now.getFullYear(), now.getMonth(), 1);
								document.getElementById('complaint-from').value = formatDate(from);
								document.getElementById('complaint-to').value = formatDate(now);
								updateComplaintChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'yearly') {
								document.getElementById('complaint-year-selector').style.display = 'inline-block';
								const year = document.getElementById('complaint-year-select').value;
								updateComplaintChart('yearly', null, null, year);
							}
						});
					});

					// Year change
					document.getElementById('complaint-year-select').addEventListener('change', () => {
						const year = document.getElementById('complaint-year-select').value;
						updateComplaintChart('yearly', null, null, year);
					});

					// Apply button
					document.getElementById('complaint-chart-form').addEventListener('submit', e => {
						e.preventDefault();
						const from = document.getElementById('complaint-from').value;
						const to = document.getElementById('complaint-to').value;
						document.getElementById('complaint-year-selector').style.display = 'none';
						updateComplaintChart('daily', from, to);
					});

					// Initial load
					updateComplaintChart('daily', formatDate(from), formatDate(now));
				}

			</script>

			<script>
				let breakdownChart = null;

				function updateBreakdownChart(mode, from = null, to = null, year = null) {
					const ctx = document.getElementById('breakdown-line-chart').getContext('2d');
					if (breakdownChart) breakdownChart.destroy();

					if (mode === 'yearly') {
						fetch(`/api/dashboards/monthly-breakdown?year=${year}`)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data)) return;

								const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
									"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
								const values = Array(12).fill(0);
								const counts = Array(12).fill(0); // Store breakdownCount

								data.forEach(d => {
									const i = d.month - 1;
									if (i >= 0 && i < 12) {
										values[i] = d.totalResolutionTimeMinutes || 0;
										counts[i] = d.breakdownCount || 0;
									}
								});

								breakdownChart = new Chart(ctx, {
									type: 'line',
									data: {  // ✅ Fixed: Added 'data:'
										labels: months,
										datasets: [{
											label: "Total Resolution Time (min)",
											borderColor: "#1d7af3",
											pointBorderColor: "#FFF",
											pointBackgroundColor: "#1d7af3",
											pointBorderWidth: 2,
											pointHoverRadius: 4,
											pointRadius: 4,
											backgroundColor: 'transparent',
											fill: true,
											borderWidth: 2,
											data: values,
											breakdownCounts: counts // Attach for tooltip
										}]
									},
									options: {
										responsive: true,
										maintainAspectRatio: false,
										legend: {
											position: 'bottom',
											labels: { fontColor: '#1d7af3' }
										},
										tooltips: {
											mode: "nearest",
											intersect: false,
											callbacks: {
												label: function (tooltipItem, data) {
													const dataset = data.datasets[0];
													const value = dataset.data[tooltipItem.index];
													const count = dataset.breakdownCounts[tooltipItem.index];
													return [
														`Breakdown Total Time: ${value} min`,
														`Breakdown Count: ${count}`
													];
												}
											}
										}
									}
								});
							});

					} else {
						fetch(`/api/dashboards/daily-breakdown?from=${from}&to=${to}`)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data)) return;

								const labels = data.map(d => d.date);
								const values = data.map(d => d.totalResolutionTimeMinutes || 0);
								const counts = data.map(d => d.breakdownCount || 0);

								breakdownChart = new Chart(ctx, {
									type: 'line',
									data: {  // ✅ Fixed: Added 'data:'
										labels: labels,
										datasets: [{
											label: "Total Resolution Time (min)",
											borderColor: "#1d7af3",
											pointBorderColor: "#FFF",
											pointBackgroundColor: "#1d7af3",
											pointBorderWidth: 2,
											pointHoverRadius: 4,
											pointRadius: 4,
											backgroundColor: 'transparent',
											fill: true,
											borderWidth: 2,
											data: values,
											breakdownCounts: counts // Attach for tooltip
										}]
									},
									options: {
										responsive: true,
										maintainAspectRatio: false,
										legend: {
											position: 'bottom',
											labels: { fontColor: '#1d7af3' }
										},
										tooltips: {
											mode: "nearest",
											intersect: false,
											callbacks: {
												label: function (tooltipItem, data) {
													const dataset = data.datasets[0];
													const value = dataset.data[tooltipItem.index];
													const count = dataset.breakdownCounts[tooltipItem.index];
													return [
														`Total Time: ${value} min`,
														`Count: ${count}`
													];
												}
											}
										}
									}
								});
							});
					}
				}
				function initBreakdownChartForm() {
					const now = new Date();
					const from = new Date(now);
					from.setDate(now.getDate() - 6);

					document.getElementById('breakdown-from').value = formatDate(from);
					document.getElementById('breakdown-to').value = formatDate(now);

					// Populate year selector
					populateYearSelector('breakdown-year-select', now.getFullYear());

					// Quick buttons
					document.querySelectorAll('#breakdown-chart-form .btn[data-range]').forEach(btn => {
						btn.addEventListener('click', () => {
							const range = btn.getAttribute('data-range');
							const now = new Date();
							if (range === 'weekly') {
								document.getElementById('breakdown-year-selector').style.display = 'none';
								const from = new Date(now);
								from.setDate(now.getDate() - 6);
								document.getElementById('breakdown-from').value = formatDate(from);
								document.getElementById('breakdown-to').value = formatDate(now);
								updateBreakdownChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'monthly') {
								document.getElementById('breakdown-year-selector').style.display = 'none';
								const from = new Date(now.getFullYear(), now.getMonth(), 1);
								document.getElementById('breakdown-from').value = formatDate(from);
								document.getElementById('breakdown-to').value = formatDate(now);
								updateBreakdownChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'yearly') {
								document.getElementById('breakdown-year-selector').style.display = 'inline-block';
								const year = document.getElementById('breakdown-year-select').value;
								updateBreakdownChart('yearly', null, null, year);
							}
						});
					});

					// Year change
					document.getElementById('breakdown-year-select').addEventListener('change', () => {
						const year = document.getElementById('breakdown-year-select').value;
						updateBreakdownChart('yearly', null, null, year);
					});

					// Apply button
					document.getElementById('breakdown-chart-form').addEventListener('submit', e => {
						e.preventDefault();
						const from = document.getElementById('breakdown-from').value;
						const to = document.getElementById('breakdown-to').value;
						document.getElementById('breakdown-year-selector').style.display = 'none';
						updateBreakdownChart('daily', from, to);
					});

					// Initial load
					updateBreakdownChart('daily', formatDate(from), formatDate(now));
				}
			</script>
			<script>
				let workReportChart = null;

				function updateWorkReportChart(mode, from = null, to = null, year = null) {
					const ctx = document.getElementById('work-report-line-chart').getContext('2d');
					if (workReportChart) workReportChart.destroy();

					if (mode === 'yearly') {
						fetch(`/api/dashboards/monthly-work-report?year=${year}`)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data)) return;

								const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
									"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
								const labels = months;

								// Initialize datasets
								const correctiveData = Array(12).fill(0);
								const preventiveData = Array(12).fill(0);
								const breakdownData = Array(12).fill(0);
								const otherData = Array(12).fill(0);

								data.forEach(d => {
									const i = d.month - 1;
									if (i >= 0 && i < 12) {
										correctiveData[i] = d.correctiveMaintenanceCount || 0;
										preventiveData[i] = d.preventiveMaintenanceCount || 0;
										breakdownData[i] = d.breakdownCount || 0;
										otherData[i] = d.otherCount || 0;
									}
								});

								workReportChart = new Chart(ctx, {
									type: 'line',
									data: {
										labels: labels,
										datasets: [
											{
												label: "Corrective Maintenance",
												borderColor: "#e74c3c",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#e74c3c",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: correctiveData,
												counts: correctiveData
											},
											{
												label: "Preventive Maintenance",
												borderColor: "#3498db",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#3498db",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: preventiveData,
												counts: preventiveData
											},
											{
												label: "Breakdown",
												borderColor: "#f39c12",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#f39c12",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: breakdownData,
												counts: breakdownData
											},
											{
												label: "Other",
												borderColor: "#95a5a6",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#95a5a6",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: otherData,
												counts: otherData
											}
										]
									},
									options: {
										responsive: true,
										maintainAspectRatio: false,
										legend: {
											position: 'bottom',
											labels: { fontColor: '#333', padding: 15 }
										},
										tooltips: {
											mode: "nearest",
											intersect: false,
											callbacks: {
												label: function (tooltipItem, data) {
													const dataset = data.datasets[tooltipItem.datasetIndex];
													const value = dataset.data[tooltipItem.index];
													const label = dataset.label;
													return `${label}: ${value} reports`;
												}
											}
										},
										scales: {
											x: { stacked: false },
											y: {
												beginAtZero: true,
												ticks: {
													stepSize: 1,
													callback: function (value) {
														return Number.isInteger(value) ? value : null;
													}
												},
												title: {
													display: true,
													text: 'Number of Reports'
												}
											}
										}
									}
								});
							});

					} else {
						fetch(`/api/dashboards/daily-work-report?from=${from}&to=${to}`)
							.then(r => r.json())
							.then(data => {
								if (!Array.isArray(data)) return;

								const labels = data.map(d => d.date);
								const correctiveData = data.map(d => d.correctiveMaintenanceCount || 0);
								const preventiveData = data.map(d => d.preventiveMaintenanceCount || 0);
								const breakdownData = data.map(d => d.breakdownCount || 0);
								const otherData = data.map(d => d.otherCount || 0);

								workReportChart = new Chart(ctx, {
									type: 'line',
									data: {
										labels: labels,
										datasets: [
											{
												label: "Corrective Maintenance",
												borderColor: "#e74c3c",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#e74c3c",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: correctiveData,
												counts: correctiveData
											},
											{
												label: "Preventive Maintenance",
												borderColor: "#3498db",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#3498db",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: preventiveData,
												counts: preventiveData
											},
											{
												label: "Breakdown",
												borderColor: "#f39c12",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#f39c12",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: breakdownData,
												counts: breakdownData
											},
											{
												label: "Other",
												borderColor: "#95a5a6",
												pointBorderColor: "#FFF",
												pointBackgroundColor: "#95a5a6",
												pointBorderWidth: 2,
												pointHoverRadius: 4,
												pointRadius: 4,
												backgroundColor: 'transparent',
												fill: false,
												borderWidth: 2,
												data: otherData,
												counts: otherData
											}
										]
									},
									options: {
										responsive: true,
										maintainAspectRatio: false,
										legend: {
											position: 'bottom',
											labels: { fontColor: '#333', padding: 15 }
										},
										tooltips: {
											mode: "nearest",
											intersect: false,
											callbacks: {
												label: function (tooltipItem, data) {
													const dataset = data.datasets[tooltipItem.datasetIndex];
													const value = dataset.data[tooltipItem.index];
													const label = dataset.label;
													return `${label}: ${value} reports`;
												}
											}
										},
										scales: {
											x: { stacked: false },
											y: {
												beginAtZero: true,
												ticks: {
													stepSize: 1,
													callback: function (value) {
														return Number.isInteger(value) ? value : null;
													}
												},
												title: {
													display: true,
													text: 'Number of Reports'
												}
											}
										}
									}
								});
							});
					}
				}

				function initWorkReportChartForm() {
					const now = new Date();
					const from = new Date(now);
					from.setDate(now.getDate() - 6);

					document.getElementById('work-report-from').value = formatDate(from);
					document.getElementById('work-report-to').value = formatDate(now);

					// Populate year selector
					populateYearSelector('work-report-year-select', now.getFullYear());

					// Quick buttons
					document.querySelectorAll('#work-report-chart-form .btn[data-range]').forEach(btn => {
						btn.addEventListener('click', () => {
							const range = btn.getAttribute('data-range');
							const now = new Date();
							if (range === 'weekly') {
								document.getElementById('work-report-year-selector').style.display = 'none';
								const from = new Date(now);
								from.setDate(now.getDate() - 6);
								document.getElementById('work-report-from').value = formatDate(from);
								document.getElementById('work-report-to').value = formatDate(now);
								updateWorkReportChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'monthly') {
								document.getElementById('work-report-year-selector').style.display = 'none';
								const from = new Date(now.getFullYear(), now.getMonth(), 1);
								document.getElementById('work-report-from').value = formatDate(from);
								document.getElementById('work-report-to').value = formatDate(now);
								updateWorkReportChart('daily', formatDate(from), formatDate(now));
							} else if (range === 'yearly') {
								document.getElementById('work-report-year-selector').style.display = 'inline-block';
								const year = document.getElementById('work-report-year-select').value;
								updateWorkReportChart('yearly', null, null, year);
							}
						});
					});

					// Year change
					document.getElementById('work-report-year-select').addEventListener('change', () => {
						const year = document.getElementById('work-report-year-select').value;
						updateWorkReportChart('yearly', null, null, year);
					});

					// Apply button
					document.getElementById('work-report-chart-form').addEventListener('submit', e => {
						e.preventDefault();
						const from = document.getElementById('work-report-from').value;
						const to = document.getElementById('work-report-to').value;
						document.getElementById('work-report-year-selector').style.display = 'none';
						updateWorkReportChart('daily', from, to);
					});

					// Initial load
					updateWorkReportChart('daily', formatDate(from), formatDate(now));
				}

				// Helper: format date to YYYY-MM-DD
				function formatDate(date) {
					return date.toISOString().split('T')[0];
				}

				// Helper: populate year selector
				function populateYearSelector(selectId, selectedYear) {
					const select = document.getElementById(selectId);
					const currentYear = new Date().getFullYear();
					select.innerHTML = '';
					for (let y = currentYear - 10; y <= currentYear + 1; y++) {
						const opt = new Option(y, y);
						if (y === selectedYear) opt.selected = true;
						select.appendChild(opt);
					}
				}
			</script>
			<script>
(() => {
    // Unique identifiers
    const CHART_FORM_ID = 'wr-chart-form';
    const FROM_INPUT_ID = 'wr-from';
    const TO_INPUT_ID = 'wr-to';
    const EQUIPMENT_SELECT_ID = 'wr-equipment';
    const YEAR_SELECT_ID = 'wr-year-select';
    const YEAR_SELECTOR_DIV = 'wr-year-selector';
    const CHART_CANVAS_ID = 'wr-equipment-line-chart';

    const DAILY_API_URL = `${baseUrl}/api/dashboards/daily-work-report-equipment`;
    const MONTHLY_API_URL = `${baseUrl}/api/dashboards/monthly-work-report-equipment`;
    const EQUIPMENT_API_URL = `${baseUrl}/api/dashboards/equipment-complaint-count`;

    let workReportChart = null;
    let equipmentList = [];

    // --- Helper: Format Date to YYYY-MM-DD ---
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    // --- Helper: Populate Year Selector ---
    function populateYearSelector(selectId, selectedYear) {
        const select = document.getElementById(selectId);
        const currentYear = new Date().getFullYear();
        select.innerHTML = '';
        for (let y = currentYear - 10; y <= currentYear + 1; y++) {
            const opt = new Option(y, y);
            if (y === selectedYear) opt.selected = true;
            select.appendChild(opt);
        }
    }

    // --- Fetch Equipment List ---
    async function fetchEquipmentList() {
        try {
            const response = await fetch(EQUIPMENT_API_URL);
            if (!response.ok) throw new Error('Failed to fetch equipment list');
            equipmentList = await response.json();

            const select = document.getElementById(EQUIPMENT_SELECT_ID);
            select.innerHTML = '<option value="">All Equipment</option>';

            equipmentList.forEach(eq => {
                const opt = new Option(eq.equipmentName, eq.equipmentCode);
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('Error loading equipment list:', err);
        }
    }

    // --- Update Chart ---
    function updateWorkReportChart(mode, from = null, to = null, year = null) {
        const ctx = document.getElementById(CHART_CANVAS_ID).getContext('2d');
        if (workReportChart) workReportChart.destroy();

        let url = '';
        let labels = [];
        let isMonthly = false;

        const equipmentCode = document.getElementById(EQUIPMENT_SELECT_ID).value;

        if (mode === 'yearly') {
            url = `${MONTHLY_API_URL}?year=${year}`;
            if (equipmentCode) url += `&equipmentCode=${encodeURIComponent(equipmentCode)}`;
            isMonthly = true;
        } else {
            url = `${DAILY_API_URL}?from=${from}&to=${to}`;
            if (equipmentCode) url += `&equipmentCode=${encodeURIComponent(equipmentCode)}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!Array.isArray(data)) return;

                if (isMonthly) {
                    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    labels = months;
                } else {
                    labels = data.map(d => d.date);
                }

                const correctiveData = Array(labels.length).fill(0);
                const preventiveData = Array(labels.length).fill(0);
                const breakdownData = Array(labels.length).fill(0);
                const otherData = Array(labels.length).fill(0);

                data.forEach(d => {
                    let idx;
                    if (isMonthly) {
                        idx = d.month - 1;
                    } else {
                        idx = labels.indexOf(d.date);
                    }
                    if (idx >= 0 && idx < labels.length) {
                        correctiveData[idx] = d.correctiveMaintenanceCount || 0;
                        preventiveData[idx] = d.preventiveMaintenanceCount || 0;
                        breakdownData[idx] = d.breakdownCount || 0;
                        otherData[idx] = d.otherCount || 0;
                    }
                });

                workReportChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Corrective Maintenance",
                                borderColor: "#e74c3c",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#e74c3c",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: correctiveData
                            },
                            {
                                label: "Preventive Maintenance",
                                borderColor: "#3498db",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#3498db",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: preventiveData
                            },
                            {
                                label: "Breakdown",
                                borderColor: "#f39c12",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#f39c12",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: breakdownData
                            },
                            {
                                label: "Other",
                                borderColor: "#95a5a6",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#95a5a6",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: otherData
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        legend: {
                            position: 'bottom',
                            labels: { fontColor: '#333', padding: 15 }
                        },
                        tooltips: {
                            mode: "nearest",
                            intersect: false,
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    const dataset = data.datasets[tooltipItem.datasetIndex];
                                    const value = dataset.data[tooltipItem.index];
                                    const label = dataset.label;
                                    return `${label}: ${value} reports`;
                                }
                            }
                        },
                        scales: {
                            x: { stacked: false },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : null;
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Reports'
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => console.error('Error loading work report data:', err));
    }

    // --- Initialize Form ---
    function initWorkReportChartForm() {
        const now = new Date();
        const from = new Date(now);
        from.setDate(now.getDate() - 6);

        document.getElementById(FROM_INPUT_ID).value = formatDate(from);
        document.getElementById(TO_INPUT_ID).value = formatDate(now);

        populateYearSelector(YEAR_SELECT_ID, now.getFullYear());

        // Quick buttons
        document.querySelectorAll(`#${CHART_FORM_ID} .btn[data-range]`).forEach(btn => {
            btn.addEventListener('click', () => {
                const range = btn.getAttribute('data-range');
                const now = new Date();

                if (range === 'weekly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
                    const from = new Date(now);
                    from.setDate(now.getDate() - 6);
                    document.getElementById(FROM_INPUT_ID).value = formatDate(from);
                    document.getElementById(TO_INPUT_ID).value = formatDate(now);
                    updateWorkReportChart('daily', formatDate(from), formatDate(now));
                } else if (range === 'monthly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
                    const from = new Date(now.getFullYear(), now.getMonth(), 1);
                    document.getElementById(FROM_INPUT_ID).value = formatDate(from);
                    document.getElementById(TO_INPUT_ID).value = formatDate(now);
                    updateWorkReportChart('daily', formatDate(from), formatDate(now));
                } else if (range === 'yearly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'inline-block';
                    const year = document.getElementById(YEAR_SELECT_ID).value;
                    updateWorkReportChart('yearly', null, null, year);
                }
            });
        });

        // Year change
        document.getElementById(YEAR_SELECT_ID).addEventListener('change', () => {
            const year = document.getElementById(YEAR_SELECT_ID).value;
            updateWorkReportChart('yearly', null, null, year);
        });

        // Apply button
        document.getElementById(CHART_FORM_ID).addEventListener('submit', e => {
            e.preventDefault();
            const from = document.getElementById(FROM_INPUT_ID).value;
            const to = document.getElementById(TO_INPUT_ID).value;
            document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
            updateWorkReportChart('daily', from, to);
        });

        // Equipment change
        document.getElementById(EQUIPMENT_SELECT_ID).addEventListener('change', () => {
            const from = document.getElementById(FROM_INPUT_ID).value;
            const to = document.getElementById(TO_INPUT_ID).value;
            const year = document.getElementById(YEAR_SELECT_ID).value;

            if (document.getElementById(YEAR_SELECTOR_DIV).style.display === 'inline-block') {
                updateWorkReportChart('yearly', null, null, year);
            } else {
                updateWorkReportChart('daily', from, to);
            }
        });

        // Initial load
        updateWorkReportChart('daily', formatDate(from), formatDate(now));
    }

    // --- On Load ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchEquipmentList().then(() => {
            initWorkReportChartForm();
        });
    });
})();
</script>

			<script>
				window.addEventListener('DOMContentLoaded', () => {
					initComplaintChartForm();
					initBreakdownChartForm();
					initWorkReportChartForm();
				});
			</script>














		</div>

		<footer class="footer">
			<div class="container-fluid">
				<nav class="pull-left">
					<ul class="nav">
						<li class="nav-item">
							<a class="nav-link" href="https://www.themekita.com">
								ThemeKita
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">
								Help
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">
								Licenses
							</a>
						</li>
					</ul>
				</nav>
				<div class="copyright ml-auto">
					2018, made with <i class="fa fa-heart heart text-danger"></i> by <a
						href="https://www.themekita.com">ThemeKita</a>
				</div>
			</div>
		</footer>
	</div>

	<!-- Scripts Fragment -->
	<th:block layout:fragment="scripts">
		<script th:inline="javascript">
			/*<![CDATA[*/
			const baseUrl = /*[[${@environment.getProperty('server.servlet.context-path', '')}]]*/ '' || '';
			const apiEndpoint = baseUrl + '/api/dashboards/status-count';
			/*]]>*/
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<!-- <script th:src="@{/js/document-modal.js}"></script> -->

		<script>
(() => {
    // Unique identifiers
    const CHART_FORM_ID = 'wr-chart-form';
    const FROM_INPUT_ID = 'wr-from';
    const TO_INPUT_ID = 'wr-to';
    const EQUIPMENT_SELECT_ID = 'wr-equipment';
    const YEAR_SELECT_ID = 'wr-year-select';
    const YEAR_SELECTOR_DIV = 'wr-year-selector';
    const CHART_CANVAS_ID = 'wr-equipment-line-chart';

    const DAILY_API_URL = `${baseUrl}/api/dashboards/daily-work-report`;
    const MONTHLY_API_URL = `${baseUrl}/api/dashboards/monthly-work-report`;
    const EQUIPMENT_API_URL = `${baseUrl}/api/dashboards/equipment-complaint-count`;

    let workReportChart = null;
    let equipmentList = [];

    // --- Helper: Format Date to YYYY-MM-DD ---
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    // --- Helper: Populate Year Selector ---
    function populateYearSelector(selectId, selectedYear) {
        const select = document.getElementById(selectId);
        const currentYear = new Date().getFullYear();
        select.innerHTML = '';
        for (let y = currentYear - 10; y <= currentYear + 1; y++) {
            const opt = new Option(y, y);
            if (y === selectedYear) opt.selected = true;
            select.appendChild(opt);
        }
    }

    // --- Fetch Equipment List ---
    async function fetchEquipmentList() {
        try {
            const response = await fetch(EQUIPMENT_API_URL);
            if (!response.ok) throw new Error('Failed to fetch equipment list');
            equipmentList = await response.json();

            const select = document.getElementById(EQUIPMENT_SELECT_ID);
            select.innerHTML = '<option value="">All Equipment</option>';

            equipmentList.forEach(eq => {
                const opt = new Option(eq.equipmentName, eq.equipmentCode);
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('Error loading equipment list:', err);
        }
    }

    // --- Update Chart ---
    function updateWorkReportChart(mode, from = null, to = null, year = null) {
        const ctx = document.getElementById(CHART_CANVAS_ID).getContext('2d');
        if (workReportChart) workReportChart.destroy();

        let url = '';
        let labels = [];
        let isMonthly = false;

        const equipmentCode = document.getElementById(EQUIPMENT_SELECT_ID).value;

        if (mode === 'yearly') {
            url = `${MONTHLY_API_URL}?year=${year}`;
            if (equipmentCode) url += `&equipmentCode=${encodeURIComponent(equipmentCode)}`;
            isMonthly = true;
        } else {
            url = `${DAILY_API_URL}?from=${from}&to=${to}`;
            if (equipmentCode) url += `&equipmentCode=${encodeURIComponent(equipmentCode)}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!Array.isArray(data)) return;

                if (isMonthly) {
                    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    labels = months;
                } else {
                    labels = data.map(d => d.date);
                }

                const correctiveData = Array(labels.length).fill(0);
                const preventiveData = Array(labels.length).fill(0);
                const breakdownData = Array(labels.length).fill(0);
                const otherData = Array(labels.length).fill(0);

                data.forEach(d => {
                    let idx;
                    if (isMonthly) {
                        idx = d.month - 1;
                    } else {
                        idx = labels.indexOf(d.date);
                    }
                    if (idx >= 0 && idx < labels.length) {
                        correctiveData[idx] = d.correctiveMaintenanceCount || 0;
                        preventiveData[idx] = d.preventiveMaintenanceCount || 0;
                        breakdownData[idx] = d.breakdownCount || 0;
                        otherData[idx] = d.otherCount || 0;
                    }
                });

                workReportChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Corrective Maintenance",
                                borderColor: "#e74c3c",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#e74c3c",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: correctiveData
                            },
                            {
                                label: "Preventive Maintenance",
                                borderColor: "#3498db",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#3498db",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: preventiveData
                            },
                            {
                                label: "Breakdown",
                                borderColor: "#f39c12",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#f39c12",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: breakdownData
                            },
                            {
                                label: "Other",
                                borderColor: "#95a5a6",
                                pointBorderColor: "#FFF",
                                pointBackgroundColor: "#95a5a6",
                                pointBorderWidth: 2,
                                pointHoverRadius: 4,
                                pointRadius: 4,
                                backgroundColor: 'transparent',
                                fill: false,
                                borderWidth: 2,
                                data: otherData
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        legend: {
                            position: 'bottom',
                            labels: { fontColor: '#333', padding: 15 }
                        },
                        tooltips: {
                            mode: "nearest",
                            intersect: false,
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    const dataset = data.datasets[tooltipItem.datasetIndex];
                                    const value = dataset.data[tooltipItem.index];
                                    const label = dataset.label;
                                    return `${label}: ${value} reports`;
                                }
                            }
                        },
                        scales: {
                            x: { stacked: false },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : null;
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Reports'
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => console.error('Error loading work report data:', err));
    }

    // --- Initialize Form ---
    function initWorkReportChartForm() {
        const now = new Date();
        const from = new Date(now);
        from.setDate(now.getDate() - 6);

        document.getElementById(FROM_INPUT_ID).value = formatDate(from);
        document.getElementById(TO_INPUT_ID).value = formatDate(now);

        populateYearSelector(YEAR_SELECT_ID, now.getFullYear());

        // Quick buttons
        document.querySelectorAll(`#${CHART_FORM_ID} .btn[data-range]`).forEach(btn => {
            btn.addEventListener('click', () => {
                const range = btn.getAttribute('data-range');
                const now = new Date();

                if (range === 'weekly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
                    const from = new Date(now);
                    from.setDate(now.getDate() - 6);
                    document.getElementById(FROM_INPUT_ID).value = formatDate(from);
                    document.getElementById(TO_INPUT_ID).value = formatDate(now);
                    updateWorkReportChart('daily', formatDate(from), formatDate(now));
                } else if (range === 'monthly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
                    const from = new Date(now.getFullYear(), now.getMonth(), 1);
                    document.getElementById(FROM_INPUT_ID).value = formatDate(from);
                    document.getElementById(TO_INPUT_ID).value = formatDate(now);
                    updateWorkReportChart('daily', formatDate(from), formatDate(now));
                } else if (range === 'yearly') {
                    document.getElementById(YEAR_SELECTOR_DIV).style.display = 'inline-block';
                    const year = document.getElementById(YEAR_SELECT_ID).value;
                    updateWorkReportChart('yearly', null, null, year);
                }
            });
        });

        // Year change
        document.getElementById(YEAR_SELECT_ID).addEventListener('change', () => {
            const year = document.getElementById(YEAR_SELECT_ID).value;
            updateWorkReportChart('yearly', null, null, year);
        });

        // Apply button
        document.getElementById(CHART_FORM_ID).addEventListener('submit', e => {
            e.preventDefault();
            const from = document.getElementById(FROM_INPUT_ID).value;
            const to = document.getElementById(TO_INPUT_ID).value;
            document.getElementById(YEAR_SELECTOR_DIV).style.display = 'none';
            updateWorkReportChart('daily', from, to);
        });

        // Equipment change
        document.getElementById(EQUIPMENT_SELECT_ID).addEventListener('change', () => {
            const from = document.getElementById(FROM_INPUT_ID).value;
            const to = document.getElementById(TO_INPUT_ID).value;
            const year = document.getElementById(YEAR_SELECT_ID).value;

            if (document.getElementById(YEAR_SELECTOR_DIV).style.display === 'inline-block') {
                updateWorkReportChart('yearly', null, null, year);
            } else {
                updateWorkReportChart('daily', from, to);
            }
        });

        // Initial load
        updateWorkReportChart('daily', formatDate(from), formatDate(now));
    }

    // --- On Load ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchEquipmentList().then(() => {
            initWorkReportChartForm();
        });
    });
})();
</script>
		<script>
			// Helper: format date for datetime-local input (safe, no timezone shift)
			function toDateTimeLocal(date) {
				const pad = (n) => n.toString().padStart(2, '0');
				const year = date.getFullYear();
				const month = pad(date.getMonth() + 1); // 0-indexed
				const day = pad(date.getDate());
				const hours = pad(date.getHours());
				const minutes = pad(date.getMinutes());
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			}

			// Set default dates: today (start and end of day)
			function setComplaintStatsDefaults() {
				const now = new Date();
				const startOfDay = new Date(now);
				startOfDay.setHours(0, 0, 0, 0);

				const endOfDay = new Date(now);
				endOfDay.setHours(23, 59, 59, 999);

				const fromInput = document.getElementById('complaint-stats-from');
				const toInput = document.getElementById('complaint-stats-to');

				if (fromInput && toInput) {
					fromInput.value = toDateTimeLocal(startOfDay);
					toInput.value = toDateTimeLocal(endOfDay);
				}
			}

			// Fetch dashboard data
			function fetchComplaintStats(from, to) {
				let url = `${baseUrl}/api/dashboards/status-count`;
				const params = new URLSearchParams();

				if (from) params.append('from', from);
				if (to) params.append('to', to);

				if (params.toString()) {
					url += '?' + params.toString();
				}

				fetch(url)
					.then(response => {
						if (!response.ok) throw new Error('Network error');
						return response.json();
					})
					.then(data => {
						// Update card values
						document.getElementById('complaint-stats-total').textContent = data.totalAllComplaints || 0;
						document.getElementById('complaint-stats-open').textContent = data.totalOpen || 0;
						document.getElementById('complaint-stats-closed').textContent = data.totalClosed || 0;
						document.getElementById('complaint-stats-pending').textContent = data.totalPending || 0;
					})
					.catch(err => {
						console.error('Fetch error:', err);
					});
			}

			// Form submit
			document.getElementById('complaint-stats-form').addEventListener('submit', function (e) {
				e.preventDefault();
				const from = document.getElementById('complaint-stats-from').value;
				const to = document.getElementById('complaint-stats-to').value;
				fetchComplaintStats(from, to);
			});

			// On page load: set defaults and load data
			window.addEventListener('DOMContentLoaded', function () {
				setComplaintStatsDefaults();

				const from = document.getElementById('complaint-stats-from').value;
				const to = document.getElementById('complaint-stats-to').value;

				fetchComplaintStats(from, to);
			});
		</script>
		<script>
			// Wrap in IIFE to avoid global conflicts
			(() => {
				// --- Configuration (Unique IDs) ---
				const EQUIPMENT_WORK_API_URL = `${baseUrl}/api/dashboards/equipment-work-report`;
				const CONTAINER_ID = 'equipment-work-list-container';
				const PREV_BTN_ID = 'equipment-work-prev-btn';
				const NEXT_BTN_ID = 'equipment-work-next-btn';
				const REFRESH_BTN_ID = 'equipment-work-refresh-btn';

				// --- State Variables ---
				let wrCurrentPage = 1;
				const wrPageSize = 7;
				let wrAllData = [];

				// --- Utility Functions ---
				function formatNumber(num) {
					return num.toLocaleString();
				}

				function formatMinutes(minutes) {
					return `${formatNumber(minutes)} min`;
				}

				// --- Fetch Data ---
				async function fetchEquipmentWorkData() {
					const container = document.getElementById(CONTAINER_ID);
					if (!container) {
						console.error('❌ Container not found:', CONTAINER_ID);
						return;
					}

					container.innerHTML = '<div class="text-center py-3">Loading...</div>';

					try {
						const response = await fetch(EQUIPMENT_WORK_API_URL);
						if (!response.ok) {
							throw new Error(`HTTP ${response.status}: ${response.statusText}`);
						}

						wrAllData = await response.json();
						console.log('✅ API Response:', wrAllData);

						// Sort by totalWorkReports descending
						wrAllData.sort((a, b) => (b.totalWorkReports || 0) - (a.totalWorkReports || 0));

						renderPage(wrCurrentPage);
					} catch (err) {
						console.error('🚨 Error loading equipment work data:', err);
						document.getElementById(CONTAINER_ID).innerHTML = `
                <div class="text-center text-muted py-3">
                    Failed to load data: ${err.message}
                </div>
            `;
					}
				}

				// --- Render Current Page ---
				function renderPage(page) {
					const container = document.getElementById(CONTAINER_ID);
					if (!container) return;

					const start = (page - 1) * wrPageSize;
					const end = start + wrPageSize;
					const pageData = wrAllData.slice(start, end);

					container.innerHTML = ''; // Clear

					if (pageData.length === 0) {
						container.innerHTML = '<div class="text-center text-muted py-3">No data</div>';
						return;
					}

					pageData.forEach((item, index) => {
						const rank = start + index + 1;
						const div = document.createElement('div');
						div.className = 'd-flex align-items-center';
						div.style.minHeight = '50px';

						div.innerHTML = `
                <div class="mr-3 d-flex align-items-center" style="min-width: 28px;">
                    <span class="fw-bold" style="
                        font-size: 0.95rem; 
                        color: #555; 
                        font-family: 'Segoe UI', sans-serif;">
                        ${rank}
                    </span>
                </div>
                <div class="flex-1 ml-2 pt-1">
                    <h6 class="fw-bold mb-1">
                        ${item.equipmentCode}
                        <span class="text-muted pl-3">(${item.totalWorkReports} reports)</span>
                    </h6>
                    <small class="text-muted">${item.equipmentName}</small>
                </div>
                <div class="d-flex ml-auto align-items-center">
                    <small class="text-muted">${formatMinutes(item.totalResolutionTime)}</small>
                </div>
            `;
						container.appendChild(div);

						// Add separator
						const sep = document.createElement('div');
						sep.className = 'separator-dashed';
						container.appendChild(sep);
					});
				}

				// --- Button Setup ---
				function setupButtons() {
					const prevBtn = document.getElementById(PREV_BTN_ID);
					const nextBtn = document.getElementById(NEXT_BTN_ID);
					const refreshBtn = document.getElementById(REFRESH_BTN_ID);

					if (prevBtn) {
						prevBtn.addEventListener('click', () => {
							if (wrCurrentPage > 1) {
								wrCurrentPage--;
								renderPage(wrCurrentPage);
							}
						});
					} else {
						console.warn('⚠️ Prev button not found:', PREV_BTN_ID);
					}

					if (nextBtn) {
						nextBtn.addEventListener('click', () => {
							if (wrAllData.length > wrCurrentPage * wrPageSize) {
								wrCurrentPage++;
								renderPage(wrCurrentPage);
							}
						});
					} else {
						console.warn('⚠️ Next button not found:', NEXT_BTN_ID);
					}

					if (refreshBtn) {
						refreshBtn.addEventListener('click', () => {
							wrCurrentPage = 1;
							fetchEquipmentWorkData();
						});
					} else {
						console.warn('⚠️ Refresh button not found:', REFRESH_BTN_ID);
					}
				}

				// --- Enable Scroll Navigation ---
				// --- Enable Scroll Navigation (Flipped: Scroll Down = Next Page) ---
				function enableScrollNavigation() {
					const container = document.getElementById(CONTAINER_ID);
					if (!container) return;

					let isScrolling = false;

					container.addEventListener('wheel', (e) => {
						if (isScrolling) return; // Prevent rapid triggers
						e.preventDefault();

						isScrolling = true;
						setTimeout(() => { isScrolling = false; }, 300);

						const delta = e.deltaY;

						if (delta > 0) {
							// ✅ Scroll down → go to NEXT page (newer data)
							if (wrAllData.length > wrCurrentPage * wrPageSize) {
								wrCurrentPage++;
								renderPage(wrCurrentPage);
							}
						} else if (delta < 0) {
							// ✅ Scroll up → go to PREVIOUS page (older data)
							if (wrCurrentPage > 1) {
								wrCurrentPage--;
								renderPage(wrCurrentPage);
							}
						}
					});

					// Optional: Add subtle visual hint
					container.style.cursor = 'grab';
					container.setAttribute('title', 'Scroll to navigate pages');

					// Visual feedback on hover
					container.addEventListener('mouseenter', () => {
						container.style.cursor = 'grab';
					});
					container.addEventListener('mousedown', () => {
						container.style.cursor = 'grabbing';
					});
					container.addEventListener('mouseup', () => {
						container.style.cursor = 'grab';
					});
				}

				// --- On DOM Ready ---
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', () => {
						setupButtons();
						enableScrollNavigation();
						fetchEquipmentWorkData();
					});
				} else {
					// Already loaded
					setupButtons();
					enableScrollNavigation();
					fetchEquipmentWorkData();
				}
			})();
		</script>
		<!-- <script>
			let myMultipleBarChart = null; // Hold chart instance
			const now = new Date();

			// Format date for datetime-local input
			function toDateTimeLocal(date) {
				const pad = (n) => n.toString().padStart(2, '0');
				const year = date.getFullYear();
				const month = pad(date.getMonth() + 1);
				const day = pad(date.getDate());
				const hours = pad(date.getHours());
				const minutes = pad(date.getMinutes());
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			}

			// Format short date for daily chart (e.g., "Jul 1")
			function formatDailyLabel(dateStr) {
				const date = new Date(dateStr);
				return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
			}

			// Format month for monthly chart (e.g., "Jan", "Feb")
			function formatMonthlyLabel(dateStr) {
				const [year, month] = dateStr.split('-');
				const date = new Date(year, month - 1); // month is 0-indexed
				return date.toLocaleDateString('en-US', { month: 'short' });
			}

			// Set date range and update chart
			function setRange(from, to, mode = 'daily') {
				document.getElementById('from2').value = toDateTimeLocal(from);
				document.getElementById('to2').value = toDateTimeLocal(to);
				updateChart(mode);
			}

			// Fetch and update chart (supports daily/monthly)
			function updateChart(mode = 'daily') {
				let url;
				const params = new URLSearchParams();

				if (mode === 'daily') {
					// Daily: use from/to
					const from = document.getElementById('from2').value;
					const to = document.getElementById('to2').value;

					url = `${baseUrl}/api/dashboards/daily-status-count`;
					if (from) params.append('from', from);
					if (to) params.append('to', to);
				} else if (mode === 'monthly') {
					// Monthly: use year from "from" date
					const from = document.getElementById('from2').value;
					const year = from ? new Date(from).getFullYear() : now.getFullYear();
					url = `${baseUrl}/api/dashboards/monthly-status-count`;
					params.append('year', `${year}-01-01T00:00:00`); // Pass as datetime
				}

				if (params.toString()) url += '?' + params.toString();

				fetch(url)
					.then(response => {
						if (!response.ok) throw new Error('Failed to fetch data');
						return response.json();
					})
					.then(data => {
						console.log('Fetched data:', data);
						if (!data || data.length === 0) {
							console.warn("No data returned");
							return;
						}

						let labels, openData, closedData, pendingData;
						let title = '';
						let isMonthly = false;

						if (mode === 'monthly') {
							labels = data.map(row => formatMonthlyLabel(row.date));
							title = 'Monthly Ticket Summary';
							isMonthly = true;
						} else {
							labels = data.map(row => formatDailyLabel(row.date));
							title = 'Daily Ticket Summary';
						}

						openData = data.map(row => row.open || 0);
						closedData = data.map(row => row.closed || 0);
						pendingData = data.map(row => row.pending || 0);

						const stackedMax = Math.max(...data.map(row => (row.open || 0) + (row.closed || 0) + (row.pending || 0)));
						const yAxisMax = Math.ceil(stackedMax * 1.1);

						// Destroy old chart
						if (myMultipleBarChart) {
							myMultipleBarChart.destroy();
						}

						const ctx = document.getElementById('multipleBarChart').getContext('2d');
						myMultipleBarChart = new Chart(ctx, {
							type: 'bar',
							data: {
								labels: labels,
								datasets: [
									{
										label: "Open",
										backgroundColor: '#fdaf4b',
										borderColor: '#fdaf4b',
										borderWidth: 1,
										data: openData
									},
									{
										label: "Closed",
										backgroundColor: '#59d05d',
										borderColor: '#59d05d',
										borderWidth: 1,
										data: closedData
									},
									{
										label: "Pending",
										backgroundColor: '#d9534f',
										borderColor: '#d9534f',
										borderWidth: 1,
										data: pendingData
									}
								]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								legend: {
									position: 'bottom',
									labels: { fontColor: '#333', fontSize: 12 }
								},
								title: {
									display: true,
									text: title,
									fontColor: '#333',
									fontSize: 16
								},
								tooltips: {
									mode: 'index',
									intersect: false,
									backgroundColor: 'rgba(0,0,0,0.8)',
									titleFontColor: '#fff'
								},
								scales: {
									xAxes: [{
										stacked: true,
										gridLines: { display: false },
										ticks: { fontColor: '#333' }
									}],
									yAxes: [{
										stacked: true,
										gridLines: { color: 'rgba(0,0,0,0.05)' },
										ticks: {
											beginAtZero: true,
											stepSize: Math.max(1, Math.ceil(yAxisMax / 10)),
											max: Math.max(10, yAxisMax)
										},
										scaleLabel: {
											display: true,
											labelString: 'Number of Tickets',
											fontColor: '#333'
										}
									}]
								},
								animation: { duration: 1000 }
							}
						});
					})
					.catch(err => {
						console.error('Error loading chart data:', err);
						alert('Failed to load ticket data.');
					});
			}

			// Quick range buttons
			document.querySelectorAll('[data-range]').forEach(button => {
				button.addEventListener('click', () => {
					const now = new Date();
					let from = new Date(now);
					let to = new Date(now);

					switch (button.getAttribute('data-range')) {
						case 'weekly':
							from.setDate(now.getDate() - 6);
							setRange(from, to, 'daily');
							break;

						case 'monthly':
							from.setDate(1); // First day of current month
							from.setHours(0, 0, 0, 0);
							setRange(from, to, 'daily');
							break;

						case 'yearly':
							from = new Date(now.getFullYear(), 0, 1); // Jan 1 of current year
							from.setHours(0, 0, 0, 0);
							to = new Date(now.getFullYear(), 11, 31, 23, 59, 59); // Dec 31
							setRange(from, to, 'monthly'); // Switch to monthly mode
							break;
					}
				});
			});

			// Form submission (always daily)
			document.getElementById('dateRangeForm2').addEventListener('submit', function (e) {
				e.preventDefault();
				updateChart('daily');
			});

			// On load: default to last 7 days (weekly)
			window.addEventListener('DOMContentLoaded', function () {
				const now = new Date();
				const from = new Date(now);
				from.setDate(now.getDate() - 6); // 7 days total including today

				document.getElementById('from2').value = toDateTimeLocal(from);
				document.getElementById('to2').value = toDateTimeLocal(now);

				updateChart('daily'); // Load daily data by default
			});
		</script> -->
		<script>
			// Hold current date range
			let currentFrom = null;
			let currentTo = null;

			// Format date for input & API
			function toDateTimeLocal(date) {
				const pad = (n) => n.toString().padStart(2, '0');
				const year = date.getFullYear();
				const month = pad(date.getMonth() + 1);
				const day = pad(date.getDate());
				const hours = pad(date.getHours());
				const minutes = pad(date.getMinutes());
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			}

			// Format date for display: "Aug 10"
			function formatShort(dateStr) {
				const d = new Date(dateStr);
				return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
			}

			// Fetch and render data
			function fetchEngineerData(from = null, to = null) {
				let url = `${baseUrl}/api/dashboards/assignee-daily-status`;
				if (from && to) {
					url += `?from=${from}&to=${to}`;
				}

				fetch(url)
					.then(res => res.json())
					.then(data => {
						// Update current range
						currentFrom = data.dates[0];
						currentTo = data.dates[data.dates.length - 1];

						// Update headers
						const dayHeaderRow = document.getElementById('dayHeaders');
						dayHeaderRow.innerHTML = '';

						// // Update colspan
						// document.getElementById('openHeader').colSpan = numDays;
						// document.getElementById('pendingHeader').colSpan = numDays;
						// document.getElementById('closedHeader').colSpan = numDays;

						// // Generate and append day headers for each section
						// [...Array(3)].forEach(() => {
						// 	createDayThs(data.dates).forEach(th => dayHeaderRow.appendChild(th));
						// });

						const numDays = data.dates.length;

						// Helper: create day headers (Day 1, Day 2, ...)
						function createDayThs(dateArray, offset = 0) {
							const ths = [];
							for (let i = 0; i < dateArray.length; i++) {
								const th = document.createElement('th');
								th.textContent = `${formatShort(dateArray[i])}`;
								// th.textContent = `Day ${i + 1}\n(${formatShort(dateArray[i])})`;
								th.style.whiteSpace = 'pre-line';
								ths.push(th);
							}
							return ths;
						}

						// Append: Open (3 days)
						const openThs = createDayThs(data.dates);
						openThs.forEach(th => dayHeaderRow.appendChild(th));

						// Append: Pending (3 days)
						const pendingThs = createDayThs(data.dates);
						pendingThs.forEach(th => dayHeaderRow.appendChild(th));

						// Append: Closed (3 days)
						const closedThs = createDayThs(data.dates);
						closedThs.forEach(th => dayHeaderRow.appendChild(th));

						// Update body
						const tbody = document.getElementById('engineerTableBody');
						tbody.innerHTML = '';

						data.data.forEach(row => {
							const tr = document.createElement('tr');
							tr.innerHTML = `
          <td class="text-left fw-bold">${row.assignee}</td>
          ${row.open.map(v => `<td>${v}</td>`).join('')}
          ${row.pending.map(v => `<td>${v}</td>`).join('')}
          ${row.closed.map(v => `<td>${v}</td>`).join('')}
        `;
							tbody.appendChild(tr);
						});
					})
					.catch(err => {
						console.error('Failed to load engineer data:', err);
					});
			}

			// Helper: shift range by offset (in days)
			function shiftRange(offsetDays) {
				if (!currentFrom || !currentTo) return;

				const from = new Date(currentFrom);
				const to = new Date(currentTo);

				const daysDiff = Math.ceil((to - from) / (1000 * 60 * 60 * 24)); // number of days

				const newFrom = new Date(from);
				newFrom.setDate(newFrom.getDate() + offsetDays);
				const newTo = new Date(to);
				newTo.setDate(newTo.getDate() + offsetDays);

				const fromStr = toDateTimeLocal(newFrom).slice(0, 16); // '2025-08-10T00:00'
				const toStr = toDateTimeLocal(newTo).slice(0, 16);

				fetchEngineerData(fromStr, toStr);
			}

			// Buttons
			document.getElementById('prevEngineerBtn').addEventListener('click', () => {
				shiftRange(-1); // shift backward by 1 day window size
			});

			document.getElementById('nextEngineerBtn').addEventListener('click', () => {
				shiftRange(1); // shift forward
			});

			document.getElementById('refreshEngineerBtn').addEventListener('click', () => {
				currentFrom = null;
				currentTo = null;
				fetchEngineerData(); // default range
			});

			// On load: fetch default
			window.addEventListener('DOMContentLoaded', () => {
				fetchEngineerData(); // initial load
			});
		</script>
		<script>
			const API_URL = `${baseUrl}/api/dashboards/equipment-complaint-count`;

			let currentPage = 1; // 1 = first page (1-7), 2 = second page (8-14)
			const pageSize = 7;
			let allData = [];

			// Fetch data
			async function fetchEquipmentData() {
				try {
					const response = await fetch(API_URL);
					if (!response.ok) throw new Error('Failed to fetch data');
					allData = await response.json();
					renderPage(currentPage);
				} catch (err) {
					console.error('Error loading equipment data:', err);
					document.getElementById('equipmentListContainer').innerHTML = `
						<div class="text-center text-muted">Failed to load data</div>
					`;
				}
			}

			// Render current page
			function renderPage(page) {
				const container = document.getElementById('equipmentListContainer');
				container.innerHTML = '';

				const start = (page - 1) * pageSize;
				const end = start + pageSize;
				const pageData = allData.slice(start, end);

				if (pageData.length === 0) {
					container.innerHTML = `<div class="text-center text-muted">No data</div>`;
					return;
				}

				pageData.forEach((item, index) => {
					const rank = start + index + 1;
					const div = document.createElement('div');
					div.className = 'd-flex';
					div.innerHTML = `
  <div class="mr-3 d-flex align-items-center" style="min-width: 28px;">
    <span class="fw-bold" style="font-size: 0.95rem; color: #555; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      ${rank}
    </span>
  </div>
  <div class="flex-1 pt-1 ml-2">
    <h6 class="fw-bold mb-1">${item.equipmentCode}</h6>
    <small class="text-muted">${item.equipmentName}</small>
  </div>
  <div class="d-flex ml-auto align-items-center">
    <h3 class="text-info fw-bold">${item.totalComplaints}</h3>
  </div>
`;
					container.appendChild(div);

					// Add separator after each item (including before last)
					const sep = document.createElement('div');
					sep.className = 'separator-dashed';
					container.appendChild(sep);
				});
			}

			// Button Listeners
			document.getElementById('nextEquipmentBtn').addEventListener('click', () => {
				if (allData.length > currentPage * pageSize) {
					currentPage++;
					renderPage(currentPage);
				}
			});

			document.getElementById('prevEquipmentBtn').addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--;
					renderPage(currentPage);
				}
			});

			document.getElementById('refreshEquipmentBtn').addEventListener('click', () => {
				currentPage = 1;
				renderPage(currentPage);
			});

			// On Load
			window.addEventListener('DOMContentLoaded', () => {
				fetchEquipmentData();
			});
		</script>
		<script>
			document.getElementById('generateReportBtn').addEventListener('click', async function (e) {
				e.preventDefault();

				const { jsPDF } = window.jspdf;
				const btn = document.getElementById('generateReportBtn');
				const originalText = btn.innerHTML;
				btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
				btn.disabled = true;

				try {
					const pdf = new jsPDF('p', 'mm', 'a4');
					const pageWidth = pdf.internal.pageSize.getWidth();
					let y = 15;

					// Add Title
					pdf.setFontSize(20);
					pdf.setTextColor(40);
					pdf.text('Maintenance Dashboard Report', 14, y);
					y += 10;

					// Add Subtitle
					pdf.setFontSize(12);
					pdf.setTextColor(100);
					const now = new Date().toLocaleString();
					pdf.text(`Generated on: ${now}`, 14, y);
					y += 15;

					// List of elements to capture (excluding equipment)
					const sections = [
						{ element: document.querySelector('.card.full-height .card-body'), title: 'Overall Ticket Statistics', scale: 2 },
						{ element: document.querySelector('#multipleBarChart'), title: 'Daily Ticket Summary', scale: 2 },
						{ element: document.querySelector('.card .table-responsive'), title: 'Engineers Responsibility', scale: 1.5 }
					];

					// Capture all sections except equipment
					for (const section of sections) {
						if (!section.element) continue;

						if (y + 30 > 280) {
							pdf.addPage();
							y = 20;
						}
						pdf.setFontSize(14);
						pdf.setTextColor(60);
						pdf.text(section.title, 14, y);
						y += 8;

						const canvas = await html2canvas(section.element, {
							scale: section.scale,
							useCORS: true,
							backgroundColor: '#fff',
							logging: false,
							width: section.element.scrollWidth,
							height: section.element.scrollHeight
						});

						const imgData = canvas.toDataURL('image/png');
						const imgWidth = pageWidth - 28;
						const imgHeight = (canvas.height * imgWidth) / canvas.width;

						if (y + imgHeight > 280) {
							pdf.addPage();
							y = 20;
						}

						pdf.addImage(imgData, 'PNG', 14, y, imgWidth, imgHeight);
						y += imgHeight + 10;
					}

					// --- ✅ FIXED & BALANCED: Top Equipment Breakdowns ---
					{
						const tempContainer = document.createElement('div');
						tempContainer.style.fontFamily = 'Arial, sans-serif';
						tempContainer.style.fontSize = '11px';
						tempContainer.style.width = '400px';
						tempContainer.style.padding = '10px';
						tempContainer.style.backgroundColor = '#ffffff';
						tempContainer.style.boxSizing = 'border-box';

						const table = document.createElement('table');
						table.style.width = '100%';
						table.style.borderCollapse = 'collapse';

						// Header
						const thead = `
    <tr>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">#</th>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Code</th>
      <th style="text-align: left; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Name</th>
      <th style="text-align: right; padding: 6px; background-color: #007BFF; color: white; font-size: 7px; font-weight: bold;">Count</th>
    </tr>
  `;
						table.innerHTML = `<thead>${thead}</thead><tbody></tbody>`;

						const tbody = table.querySelector('tbody');

						// ✅ Only get divs that contain real equipment data
						const allDivs = Array.from(document.querySelectorAll('#equipmentListContainer > div'));
						const validItems = [];

						allDivs.forEach(div => {
							const code = div.querySelector('h6');
							const name = div.querySelector('small');
							if (code && name && code.textContent.trim() && name.textContent.trim()) {
								validItems.push({
									code: code.textContent.trim(),
									name: name.textContent.trim(),
									count: (div.querySelector('.text-info')?.textContent || '0').trim()
								});
							}
						});

						// ✅ Now map with correct ranking
						validItems.forEach((item, index) => {
							const rank = index + 1;
							const row = document.createElement('tr');
							row.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';

							row.innerHTML = `
      <td style="padding: 4px 5px; font-weight: bold; color: #333; font-size: 7px;">${rank}</td>
      <td style="padding: 4px 5px; font-weight: bold; color: #000; font-size: 7px;">${item.code}</td>
      <td style="padding: 4px 5px; color: #555; font-size: 7px;">${item.name}</td>
      <td style="padding: 4px 5px; text-align: right; font-weight: bold; color: #007bff; font-size: 7px;">${item.count}</td>
    `;

							tbody.appendChild(row);
						});

						if (validItems.length === 0) {
							const row = document.createElement('tr');
							row.innerHTML = `<td colspan="4" style="padding: 10px; text-align: center; color: #999; font-size: 10px;">No data</td>`;
							tbody.appendChild(row);
						}

						tempContainer.appendChild(table);

						// Hide from view
						tempContainer.style.position = 'absolute';
						tempContainer.style.left = '-9999px';
						tempContainer.style.top = '-9999px';
						document.body.appendChild(tempContainer);

						try {
							const canvas = await html2canvas(tempContainer, {
								scale: 2,
								backgroundColor: '#fff'
							});
							document.body.removeChild(tempContainer);

							const imgData = canvas.toDataURL('image/png');
							const imgWidth = pageWidth - 28;
							const imgHeight = (canvas.height * imgWidth) / canvas.width;

							if (y + imgHeight > 280) {
								pdf.addPage();
								y = 20;
							}

							pdf.addImage(imgData, 'PNG', 14, y, imgWidth, imgHeight);
							y += imgHeight + 10;
						} catch (err) {
							console.error('Failed to capture equipment list', err);
							document.body.removeChild(tempContainer);
							y += 30;
						}
					}
					// --- End of Equipment Section ---

					// Footer
					pdf.setFontSize(10);
					pdf.setTextColor(150);
					// pdf.text('Kaiadmin Dashboard - Clean, awesome, simple and modern', 14, y || 290);
					pdf.text(`Page 1`, pageWidth - 14, 290, { align: 'right' });

					// Save
					pdf.save(`Dashboard_Report_${new Date().toISOString().split('T')[0]}.pdf`);

				} catch (err) {
					console.error('PDF generation error:', err);
				} finally {
					btn.innerHTML = originalText;
					btn.disabled = false;
				}
			});
		</script>
		<!-- <script>
			var lineChart = document.getElementById('LineChartBreakdown').getContext('2d');
			var myLineChart = new Chart(lineChart, {
				type: 'line',
				data: {
					labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
					datasets: [{
						label: "Active Users",
						borderColor: "#1d7af3",
						pointBorderColor: "#FFF",
						pointBackgroundColor: "#1d7af3",
						pointBorderWidth: 2,
						pointHoverRadius: 4,
						pointHoverBorderWidth: 1,
						pointRadius: 4,
						backgroundColor: 'transparent',
						fill: true,
						borderWidth: 2,
						data: [542, 480, 430, 550, 530, 453, 380, 434, 568, 610, 700, 900]
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					legend: {
						position: 'bottom',
						labels: {
							padding: 10,
							fontColor: '#1d7af3',
						}
					},
					tooltips: {
						bodySpacing: 4,
						mode: "nearest",
						intersect: 0,
						position: "nearest",
						xPadding: 10,
						yPadding: 10,
						caretPadding: 10
					},
					layout: {
						padding: { left: 15, right: 15, top: 15, bottom: 15 }
					}
				}
			});
		</script> -->
	</th:block>
</body>

</html>





<!-- <div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-header">
							<div class="card-head-row">
								<div class="card-title">Equipment Statistics</div>
								<div class="card-tools">
									<a href="#" class="btn btn-info btn-border btn-round btn-sm mr-2">
										<span class="btn-label">
											<i class="fa fa-pencil"></i>
										</span>
										Export
									</a>
									<a href="#" class="btn btn-info btn-border btn-round btn-sm">
										<span class="btn-label">
											<i class="fa fa-print"></i>
										</span>
										Print
									</a>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div class="chart-container" style="min-height: 375px">
								<canvas id="statisticsChart"></canvas>
							</div>
							<div id="myChartLegend"></div>
						</div>
					</div>
				</div>
			</div> -->


<!-- <div class="row mt--2">
				<div class="col-md-4">
					<div class="row">
						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-info bubble-shadow-small">
												<i class="fas fa-folder-open text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Open Tickets</p>
												<h4 class="card-title">124</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-success bubble-shadow-small">
												<i class="fas fa-check-circle text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Closed Tickets</p>
												<h4 class="card-title">843</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-sm-6 col-md-12 mb-3">
							<div class="card card-stats card-round">
								<div class="card-body">
									<div class="row align-items-center h-100 pt-3">
										<div class="col-icon">
											<div class="icon-big text-center icon-warning bubble-shadow-small">
												<i class="fas fa-clock text-white"></i>
											</div>
										</div>
										<div class="col col-stats ml-3 ml-sm-0">
											<div class="numbers">
												<p class="card-category">Pending Tickets</p>
												<h4 class="card-title">124</h4>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-8">
					<div class="card full-height">
						<div class="card-header">
							<div class="card-title">Multiple Bar Chart</div>
						</div>
						<div class="card-body d-flex flex-column">
							<div class="chart-container flex-grow-1">
								<canvas id="multipleBarChart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div> -->
<!-- <div class="row">
				<div class="col-md-4">
					<div class="card full-height">
						<div class="card-header">
							<div class="card-head-row card-tools-still-right">
								<h4 class="card-title">Overall Statistics</h4>
								<div class="card-tools">
									<button class="btn btn-icon btn-link btn-primary btn-xs btn-refresh-card"><span
											class="fa fa-sync-alt"></span></button>
								</div>
							</div>
							<p class="card-category">
								Daily information about complaint status</p>
						</div>
						<div class="card-body">
							<div class="d-flex flex-wrap justify-content-around pb-2 pt-5">
								<div class="px-2 pb-2 pb-md-0 text-center">
									<div id="circles-1"></div>
									<h6 class="fw-bold mt-1 mb-3">Closed</h6>
								</div>
								<div class="px-2 pb-2 pb-md-0 text-center">
									<div id="circles-2"></div>
									<h6 class="fw-bold mt-1 mb-3">Open</h6>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-8">
					<div class="card full-height">
						<div class="card-body">
							<div class="card-title">Complaints of The Week</div>
							<div class="row py-3">

								<div class="col-md-12">
									<div id="chart-container">
										<canvas id="totalIncomeChart" style="height: 300px;"></canvas>
									</div>
								</div>
								<div class="col-md-12 d-flex flex-row justify-content-around mt-3">
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-success op-8">Closed</h6>
										<h3 class="fw-bold">15</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-danger op-8">Open</h6>
										<h3 class="fw-bold">48</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-success op-8">In Progress</h6>
										<h3 class="fw-bold">15</h3>
									</div>
									<div class="text-center">
										<h6 class="fw-bold text-uppercase text-danger op-8">Pending</h6>
										<h3 class="fw-bold">48</h3>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div> -->